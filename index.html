<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Assessment | Homesphere Robotics</title>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --color-bg: #f1f5f9;
      --color-surface: #ffffff;
      --color-header: #0a0a0a;
      --color-primary: #00b4d8;
      --color-primary-hover: #0096b3;
      --color-danger: #ef4444;
      --color-danger-hover: #dc2626;
      --color-text: #1e293b;
      --color-text-secondary: #64748b;
      --color-border: #e2e8f0;
      --color-green: #22c55e;
      --color-yellow: #eab308;
      --color-orange: #f97316;
      --color-red: #ef4444;
      --color-appetite-line: #0a0a0a;
      --color-accent: #00b4d8;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    header {
      background: var(--color-header);
      color: #fff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-brand img {
      height: 36px;
      width: auto;
    }

    .header-brand .brand-divider {
      width: 1px;
      height: 28px;
      background: rgba(255, 255, 255, 0.3);
    }

    .header-brand h1 {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      opacity: 0.9;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .appetite-control {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    .appetite-control label {
      color: #cbd5e1;
      white-space: nowrap;
    }

    .appetite-control select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #475569;
      background: #334155;
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: var(--color-primary);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .btn-danger {
      background: var(--color-danger);
      color: #fff;
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .btn-danger:hover {
      background: var(--color-danger-hover);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn-icon {
      background: transparent;
      border: none;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.8);
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .btn-icon:active {
      transform: scale(0.95);
    }

    /* ===== MAIN ===== */
    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ===== STATS ===== */
    .stats-primary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card-lg {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .stat-card-lg .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1.1;
    }

    .stat-card-lg .stat-label {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 6px;
    }

    .stats-breakdown {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .breakdown-header {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
    }

    .breakdown-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .stat-card {
      background: #f8fafc;
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .stat-card .stat-label {
      font-size: 0.72rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 4px;
    }

    .stat-total .stat-value {
      color: var(--color-primary);
    }

    .stat-critical .stat-value {
      color: var(--color-red);
    }

    .stat-high .stat-value {
      color: var(--color-orange);
    }

    .stat-medium .stat-value {
      color: var(--color-yellow);
    }

    .stat-appetite .stat-value {
      color: var(--color-danger);
    }

    /* ===== HEAT MAP ===== */
    .heatmap-wrapper {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }

    .heatmap-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-align: center;
      color: var(--color-text-secondary);
    }

    .heatmap-container {
      display: grid;
      grid-template-columns: auto repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr) auto;
      gap: 0;
      max-width: 600px;
      margin: 0 auto;
    }

    .y-label {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      min-width: 90px;
    }

    .x-label {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-align: center;
    }

    .corner-spacer {
      /* empty bottom-left corner */
      display: block;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      min-width: 60px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: filter 0.15s, transform 0.1s;
      position: relative;
      user-select: none;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .heatmap-cell:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
      z-index: 2;
    }

    .heatmap-cell:focus-visible {
      outline: 3px solid var(--color-primary);
      outline-offset: -3px;
      z-index: 3;
    }

    .heatmap-cell .cell-count {
      position: relative;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .heatmap-cell .cell-count.empty {
      opacity: 0.4;
    }

    /* Appetite boundary borders */
    .heatmap-cell.appetite-border-top {
      border-top: 3.5px dashed var(--color-appetite-line) !important;
    }

    .heatmap-cell.appetite-border-bottom {
      border-bottom: 3.5px dashed var(--color-appetite-line) !important;
    }

    .heatmap-cell.appetite-border-left {
      border-left: 3.5px dashed var(--color-appetite-line) !important;
    }

    .heatmap-cell.appetite-border-right {
      border-right: 3.5px dashed var(--color-appetite-line) !important;
    }

    /* Outside appetite overlay */
    .heatmap-cell.outside-appetite::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(45deg,
          transparent,
          transparent 4px,
          rgba(0, 0, 0, 0.06) 4px,
          rgba(0, 0, 0, 0.06) 6px);
      pointer-events: none;
    }

    /* Axis titles */
    .axis-title-y {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      text-align: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding-right: 8px;
    }

    .axis-title-x {
      text-align: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding-top: 12px;
      grid-column: 2 / -1;
    }

    .heatmap-outer {
      display: flex;
      align-items: stretch;
      justify-content: center;
      gap: 4px;
    }

    .heatmap-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--color-text-secondary);
    }

    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .legend-appetite {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--color-text-secondary);
    }

    .legend-appetite-line {
      width: 24px;
      height: 0;
      border-top: 3px dashed var(--color-appetite-line);
    }

    .empty-hint {
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 0.9rem;
      margin-top: 20px;
    }

    /* ===== DETAIL PANEL (slide-in sidebar) ===== */
    .detail-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 200;
    }

    .detail-backdrop.active {
      display: block;
    }

    .detail-panel {
      position: fixed;
      top: 0;
      right: -420px;
      width: 400px;
      max-width: 100vw;
      height: 100vh;
      background: var(--color-surface);
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      z-index: 210;
      transition: right 0.25s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .detail-panel.active {
      right: 0;
    }

    .detail-header {
      padding: 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-shrink: 0;
    }

    .detail-header-info h2 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-header-info .detail-meta {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
    }

    .score-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
    }

    .appetite-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 6px;
    }

    .appetite-badge.within {
      background: #dcfce7;
      color: #166534;
    }

    .appetite-badge.outside {
      background: #fef2f2;
      color: #991b1b;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 4px;
      line-height: 1;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .close-btn:hover {
      background: var(--color-bg);
      color: var(--color-text);
    }

    .detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .detail-empty {
      text-align: center;
      color: var(--color-text-secondary);
      padding: 40px 20px;
      font-size: 0.9rem;
    }

    .risk-card {
      background: #fff;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border: 1px solid var(--color-border);
      cursor: pointer;
      transition: all 0.2s;
    }

    .risk-card:hover {
      border-color: var(--color-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .risk-card.expanded {
      border-color: var(--color-primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .risk-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .risk-card-header h3 {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0;
      flex: 1;
    }

    .risk-card-header .expand-icon {
      font-size: 1.2rem;
      color: var(--color-text-secondary);
      transition: transform 0.2s;
    }

    .risk-card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .risk-card-preview {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
      margin-top: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .risk-card.expanded .risk-card-preview {
      display: none;
    }

    .risk-card-details {
      display: none;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--color-border);
    }

    .risk-card.expanded .risk-card-details {
      display: block;
    }

    .risk-detail-row {
      margin-bottom: 12px;
    }

    .risk-detail-row label {
      display: block;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .risk-detail-row .value {
      font-size: 0.85rem;
      color: var(--color-text);
    }

    .impact-breakdown {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .impact-breakdown-item {
      background: #f8fafc;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
    }

    .impact-breakdown-item .cat-name {
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .impact-breakdown-item .cat-score {
      font-weight: 700;
      margin-left: 4px;
    }

    .risk-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      justify-content: flex-end;
    }

    .risk-card-date {
      font-size: 0.72rem;
      color: #94a3b8;
    }

    /* ===== MODAL ===== */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 300;
    }

    .modal-backdrop.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: var(--color-surface);
      border-radius: 12px;
      max-width: 800px;
      max-height: 90vh;
      max-height: calc(100vh - 64px);
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      padding: 0;
    }

    .modal-header {
      padding: 20px 24px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-body {
      padding: 20px 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--color-text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: inherit;
      color: var(--color-text);
      background: #fff;
      transition: border-color 0.15s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group .form-error {
      color: var(--color-danger);
      font-size: 0.78rem;
      margin-top: 4px;
      display: none;
    }

    .form-group.has-error input,
    .form-group.has-error textarea {
      border-color: var(--color-danger);
    }

    .form-group.has-error .form-error {
      display: block;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-footer {
      padding: 0 24px 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 767px) {
      header {
        padding: 12px 16px;
      }

      header h1 {
        font-size: 1.05rem;
      }

      main {
        padding: 16px;
      }

      .y-label {
        min-width: 60px;
        font-size: 0.65rem;
      }

      .x-label {
        font-size: 0.65rem;
      }

      .heatmap-cell {
        min-width: 48px;
        min-height: 48px;
        font-size: 0.9rem;
      }

      .detail-panel {
        width: 100vw;
        right: -100vw;
      }

      .stats-row {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
    }

    @media (max-width: 479px) {
      .header-controls {
        width: 100%;
        justify-content: space-between;
      }

      .heatmap-cell {
        min-width: 40px;
        min-height: 40px;
        font-size: 0.8rem;
      }

      .y-label {
        min-width: 44px;
        font-size: 0.58rem;
      }

      .x-label {
        font-size: 0.58rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-card .stat-value {
        font-size: 1.4rem;
      }
    }

    /* ===== RUBRIC TABLE STYLES ===== */

    /* Section Headers */
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--color-border);
    }

    .section-header h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text);
      margin: 0;
    }

    .section-header .section-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      background: #e2e8f0;
      color: var(--color-text-secondary);
    }

    .section-header .section-badge.filled {
      color: #fff;
    }

    /* Rubric Table */
    .rubric-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      border: 2px solid #333;
      margin-bottom: 12px;
    }

    .rubric-table th {
      background: #666;
      color: #fff;
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
      border: 1px solid #333;
      font-size: 0.8rem;
    }

    .rubric-table td {
      padding: 10px 8px;
      border: 1px solid #333;
      vertical-align: top;
      line-height: 1.4;
    }

    .rubric-table tbody tr {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .rubric-table tbody tr:hover {
      outline: 2px solid #0ea5e9;
      outline-offset: -2px;
    }

    /* Impact table: cell-level hover instead of row */
    .impact-rubric-table tbody tr:hover {
      outline: none;
    }

    .impact-rubric-table tbody td:not(.rating-cell):hover {
      outline: 2px solid #0ea5e9;
      outline-offset: -2px;
      cursor: pointer;
    }

    .rubric-table tbody tr.selected {
      outline: 3px solid #1e293b;
      outline-offset: -3px;
      box-shadow: 0 0 0 4px rgba(30, 41, 59, 0.3);
    }

    .rubric-table .rating-cell {
      text-align: center;
      font-weight: 700;
      color: #000;
      width: 85px;
      min-width: 85px;
    }

    .rubric-table .rating-cell .rating-label {
      font-size: 0.85rem;
      display: block;
    }

    .rubric-table .rating-cell .rating-score {
      font-size: 1.1rem;
      display: block;
      margin-top: 2px;
    }

    /* Rating Colors */
    .rating-critical {
      background: #ef4444;
    }

    .rating-high {
      background: #f97316;
    }

    .rating-moderate {
      background: #eab308;
    }

    .rating-low {
      background: #84cc16;
    }

    .rating-minimal {
      background: #22c55e;
    }

    /* Probability column styling */
    .rubric-table .prob-cell {
      text-align: center;
      width: 100px;
      font-weight: 500;
    }

    .rubric-table .criteria-cell {
      color: var(--color-text-secondary);
    }

    /* Impact Table - wider cells */
    .impact-rubric-table td:not(.rating-cell) {
      font-size: 0.7rem;
    }

    /* Score Summary Container */
    .score-summary-container {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 12px;
      padding: 16px 20px;
      margin-top: 16px;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .score-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .score-type {
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
    }

    .score-calc {
      font-size: 0.7rem;
      color: #94a3b8;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .score-result {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .score-value {
      font-size: 0.9rem;
      color: #94a3b8;
    }

    .score-badge-lg {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 700;
      background: #64748b;
      color: #fff;
      min-width: 80px;
      text-align: center;
    }

    .score-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.15);
      margin: 8px 0;
    }

    .score-badge-xl {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 800;
      background: #64748b;
      color: #fff;
      min-width: 100px;
      text-align: center;
    }

    /* Weights Panel */
    .weights-panel {
      display: flex;
      gap: 16px;
      margin-bottom: 14px;
      padding: 10px 14px;
      background: #f1f5f9;
      border-radius: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .weights-panel .weight-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .weights-panel .weight-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .weights-panel .weight-item label {
      font-size: 0.7rem;
      color: var(--color-text);
      font-weight: 500;
    }

    .weights-panel .weight-item input {
      width: 45px;
      padding: 4px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      text-align: center;
      font-size: 0.75rem;
    }

    /* Settings Modal Weights */
    .settings-weights {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .settings-weight-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .settings-weight-item label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--color-text);
      margin: 0;
    }

    .weight-input-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .weight-input-group input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      text-align: center;
      font-size: 0.85rem;
    }

    .weight-input-group span {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }

    .weight-total {
      margin-top: 12px;
      padding: 10px 12px;
      background: #e2e8f0;
      border-radius: 6px;
      font-size: 0.85rem;
      text-align: right;
    }

    .weight-total.invalid {
      background: #fef2f2;
      color: var(--color-danger);
    }

    /* Rubric Editor in Settings */
    .rubric-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .rubric-editor-header label {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 0.72rem;
    }

    .rubric-editor {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .rubric-editor-item {
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 12px;
      background: #f8fafc;
    }

    .rubric-editor-item .editor-rating {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.78rem;
      font-weight: 700;
      color: #000;
      margin-bottom: 10px;
    }

    .editor-fields {
      display: grid;
      gap: 8px;
    }

    .editor-fields.likelihood-fields {
      grid-template-columns: 120px 1fr;
    }

    .editor-fields.impact-fields {
      grid-template-columns: 1fr 1fr;
    }

    .editor-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .editor-field-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .editor-field input,
    .editor-field textarea {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: inherit;
      color: var(--color-text);
      background: #fff;
      transition: border-color 0.15s;
    }

    .editor-field input:focus,
    .editor-field textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(59,130,246,0.12);
    }

    .editor-field textarea {
      min-height: 48px;
      resize: vertical;
      line-height: 1.4;
    }

    @media (max-width: 479px) {
      .editor-fields.likelihood-fields,
      .editor-fields.impact-fields {
        grid-template-columns: 1fr;
      }
    }

    /* Responsive */
    @media (max-width: 700px) {
      .rubric-table {
        font-size: 0.65rem;
      }

      .rubric-table th,
      .rubric-table td {
        padding: 6px 4px;
      }

      .rubric-table .rating-cell {
        width: 60px;
        min-width: 60px;
      }
    }

    /* ===== VIEW TOGGLE ===== */
    .view-toggle {
      display: flex;
      gap: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 4px;
      margin-right: 12px;
    }

    .btn-view {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .btn-view:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .btn-view.active {
      background: var(--color-primary);
      color: #fff;
    }

    /* ===== COMPANY PROFILE VIEW ===== */
    .company-view {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    .company-hero {
      background: linear-gradient(135deg, #0a0a0a 0%, #1e293b 100%);
      border-radius: var(--radius);
      padding: 48px 40px;
      color: #fff;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .company-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(0, 180, 216, 0.12) 0%, transparent 70%);
      pointer-events: none;
    }

    .company-hero-content {
      position: relative;
      z-index: 1;
    }

    .company-hero-tagline {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--color-primary);
      margin-bottom: 8px;
    }

    .company-hero h2 {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 12px;
    }

    .company-hero-desc {
      font-size: 1rem;
      color: #94a3b8;
      max-width: 600px;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .company-hero-stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .company-hero-stat {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px 24px;
      min-width: 150px;
      text-align: center;
    }

    .company-hero-stat .stat-val {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-primary);
      display: block;
    }

    .company-hero-stat .stat-lbl {
      font-size: 0.75rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 4px;
      display: block;
    }

    .company-section {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 28px 32px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .company-section h3 {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 16px;
      padding-left: 14px;
      border-left: 3px solid var(--color-primary);
    }

    .company-section p {
      color: var(--color-text-secondary);
      line-height: 1.7;
      font-size: 0.92rem;
    }

    .company-mission-block {
      background: linear-gradient(135deg, rgba(0, 180, 216, 0.06) 0%, rgba(0, 180, 216, 0.02) 100%);
      border-left: 3px solid var(--color-primary);
      padding: 20px 24px;
      border-radius: 0 var(--radius) var(--radius) 0;
      margin-top: 12px;
    }

    .company-mission-block p {
      color: var(--color-text);
      font-size: 1rem;
      font-weight: 500;
      font-style: italic;
    }

    .company-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 12px;
    }

    .company-product-card {
      background: var(--color-bg);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--color-border);
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .company-product-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .company-product-card .product-icon {
      font-size: 1.8rem;
      margin-bottom: 10px;
      display: block;
    }

    .company-product-card h4 {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 6px;
    }

    .company-product-card p {
      font-size: 0.82rem;
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    .company-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .company-tag {
      display: inline-block;
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 0.78rem;
      font-weight: 500;
      background: rgba(0, 180, 216, 0.1);
      color: var(--color-primary);
      border: 1px solid rgba(0, 180, 216, 0.2);
    }

    .company-tag.neutral {
      background: var(--color-bg);
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .company-roles-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .company-role-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--color-bg);
      border-radius: var(--radius);
      border: 1px solid var(--color-border);
    }

    .company-role-item .role-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-primary);
      flex-shrink: 0;
    }

    .company-role-item span {
      font-size: 0.85rem;
      color: var(--color-text);
      font-weight: 500;
    }

    .company-dept-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      margin-bottom: 20px;
    }

    .company-dept-item {
      padding: 10px 18px;
      background: linear-gradient(135deg, #0a0a0a 0%, #1e293b 100%);
      color: #fff;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 500;
    }

    .company-maturity-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .company-maturity-item {
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--color-border);
      background: var(--color-bg);
    }

    .company-maturity-item .maturity-label {
      font-size: 0.78rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 8px;
      display: block;
    }

    .company-maturity-item .maturity-status {
      font-size: 0.88rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .company-maturity-item .maturity-status.mature {
      color: var(--color-green);
    }

    .company-maturity-item .maturity-status.developing {
      color: var(--color-orange);
    }

    .maturity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .maturity-dot.green { background: var(--color-green); }
    .maturity-dot.orange { background: var(--color-orange); }

    .company-challenges-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 12px;
    }

    .company-challenges-col h4 {
      font-size: 0.82rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
    }

    .company-challenges-col ul {
      list-style: none;
      padding: 0;
    }

    .company-challenges-col li {
      padding: 10px 14px;
      background: var(--color-bg);
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--color-text);
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.5;
    }

    .company-challenges-col li .ch-icon {
      flex-shrink: 0;
      margin-top: 2px;
    }

    .company-deps-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .company-dep-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--color-bg);
      border-radius: var(--radius);
      border: 1px solid var(--color-border);
      font-size: 0.85rem;
      color: var(--color-text);
    }

    .company-dep-item .dep-icon {
      font-size: 1.1rem;
    }

    .company-mfg-note {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      padding: 14px 18px;
      background: rgba(0, 180, 216, 0.06);
      border-radius: var(--radius);
      border: 1px solid rgba(0, 180, 216, 0.15);
      font-size: 0.85rem;
      color: var(--color-text);
    }

    .company-differentiator {
      background: linear-gradient(135deg, rgba(0, 180, 216, 0.08) 0%, rgba(34, 197, 94, 0.06) 100%);
      border: 1px solid rgba(0, 180, 216, 0.2);
      border-radius: var(--radius);
      padding: 18px 22px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .company-differentiator p {
      color: var(--color-text) !important;
      font-weight: 500;
    }

    /* ===== RACI VIEW ===== */
    .raci-view {
      max-width: 100%;
      margin: 0 auto;
      padding: 24px;
    }

    .raci-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .raci-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text);
      margin: 0;
    }

    .raci-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .raci-table-wrapper {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      overflow-x: hidden;
    }

    /* ===== RACI TABLE ===== */
    .raci-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.72rem;
      table-layout: fixed;
    }

    .raci-table th,
    .raci-table td {
      border: 1px solid var(--color-border);
      padding: 6px 4px;
      text-align: center;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .raci-table th {
      background: #f8fafc;
      font-weight: 600;
      color: var(--color-text);
      word-wrap: break-word;
      white-space: normal;
      font-size: 0.68rem;
      line-height: 1.3;
    }

    .raci-table th.task-header {
      text-align: left;
      width: 180px;
      background: #e2e8f0;
    }

    .raci-table th.role-header {
      position: relative;
    }

    .raci-table td.task-cell {
      text-align: left;
      font-weight: 500;
      background: #fafafa;
      position: relative;
      word-wrap: break-word;
      white-space: normal;
    }

    .raci-table td.raci-cell {
      padding: 3px 2px;
    }

    /* Delete buttons */
    .delete-col-btn,
    .delete-row-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 1rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      transition: all 0.15s;
      vertical-align: middle;
    }

    .delete-col-btn:hover,
    .delete-row-btn:hover {
      background: #fee2e2;
      color: var(--color-danger);
    }

    /* RACI Select Dropdown */
    .raci-select {
      width: 100%;
      padding: 4px 2px;
      border: 1px solid transparent;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      background: #f8fafc;
      transition: all 0.15s;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .raci-select:hover {
      border-color: var(--color-border);
      background: #f1f5f9;
    }

    .raci-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(0, 180, 216, 0.2);
    }

    /* RACI Value Colors */
    .raci-select.raci-r {
      background: #dbeafe;
      color: #1e40af;
    }

    .raci-select.raci-a {
      background: #fef3c7;
      color: #92400e;
    }

    .raci-select.raci-c {
      background: #d1fae5;
      color: #065f46;
    }

    .raci-select.raci-i {
      background: #f3e8ff;
      color: #6b21a8;
    }

    /* RACI Badges for Legend */
    .raci-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .raci-badge.raci-r { background: #dbeafe; color: #1e40af; }
    .raci-badge.raci-a { background: #fef3c7; color: #92400e; }
    .raci-badge.raci-c { background: #d1fae5; color: #065f46; }
    .raci-badge.raci-i { background: #f3e8ff; color: #6b21a8; }

    /* RACI Legend */
    .raci-legend {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 20px;
      padding: 16px;
      background: var(--color-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .raci-legend .legend-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.8rem;
      color: var(--color-text-secondary);
    }

    .raci-legend .legend-item .raci-badge {
      flex-shrink: 0;
      margin-top: 1px;
    }

    .raci-legend .legend-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .raci-legend .legend-text strong {
      color: var(--color-text);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .raci-legend .legend-text span {
      font-size: 0.72rem;
      line-height: 1.4;
      color: var(--color-text-secondary);
    }

    /* RACI Responsive */
    @media (max-width: 767px) {
      .raci-view {
        padding: 16px;
      }

      .raci-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .raci-legend {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .view-toggle {
        margin-right: 8px;
      }

      .btn-view {
        padding: 5px 10px;
        font-size: 0.75rem;
      }

      /* Company Profile Responsive */
      .company-view {
        padding: 16px;
      }

      .company-hero {
        padding: 32px 24px;
      }

      .company-hero h2 {
        font-size: 1.6rem;
      }

      .company-hero-stats {
        flex-direction: column;
      }

      .company-hero-stat {
        min-width: unset;
      }

      .company-section {
        padding: 20px;
      }

      .company-grid,
      .company-roles-list,
      .company-challenges-grid,
      .company-deps-list {
        grid-template-columns: 1fr;
      }

      .company-maturity-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="firebase-config.js?v=2"></script>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="header-brand">
      <img src="logo.png" alt="Homesphere Robotics">
      <div class="brand-divider"></div>
      <h1>Risk Assessment</h1>
    </div>
    <div class="header-controls">
      <div class="view-toggle">
        <button class="btn-view active" id="view-heatmap">Heatmap</button>
        <button class="btn-view" id="view-raci">RACI</button>
        <button class="btn-view" id="view-company">Company</button>
      </div>
      <button class="btn-icon" id="settings-btn" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg>
      </button>
      <button class="btn btn-primary" id="add-risk-btn">+ Add Risk</button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    <!-- PRIMARY STATS ROW -->
    <div class="stats-primary">
      <div class="stat-card-lg stat-total">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total Risks</div>
      </div>
      <div class="stat-card-lg stat-appetite">
        <div class="stat-value" id="stat-appetite">0</div>
        <div class="stat-label">Outside Appetite</div>
      </div>
    </div>

    <!-- RISK BREAKDOWN -->
    <div class="stats-breakdown">
      <div class="breakdown-header">Risk Breakdown by Severity</div>
      <div class="breakdown-cards">
        <div class="stat-card stat-critical">
          <div class="stat-value" id="stat-critical">0</div>
          <div class="stat-label">Critical</div>
        </div>
        <div class="stat-card stat-high">
          <div class="stat-value" id="stat-high">0</div>
          <div class="stat-label">High</div>
        </div>
        <div class="stat-card stat-medium">
          <div class="stat-value" id="stat-medium">0</div>
          <div class="stat-label">Medium / Low</div>
        </div>
      </div>
    </div>

    <!-- HEAT MAP -->
    <div class="heatmap-wrapper">
      <div class="heatmap-outer">
        <div class="axis-title-y">Impact</div>
        <div class="heatmap-inner">
          <div class="heatmap-container" id="heatmap-grid"></div>
          <div class="axis-title-x">Likelihood</div>
        </div>
      </div>

      <!-- Legend -->
      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch" style="background:#22c55e;"></div>
          Low (1-3)
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#eab308;"></div>
          Medium (4-6)
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#f97316;"></div>
          High (7-12)
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#ef4444;"></div>
          Critical (13-25)
        </div>
        <div class="legend-appetite">
          <div class="legend-appetite-line"></div>
          Risk Appetite Boundary
        </div>
      </div>
    </div>

    <p class="empty-hint" id="empty-hint">Click "+ Add Risk" to get started.</p>
  </main>

  <!-- RACI VIEW -->
  <section class="raci-view" id="raci-view" style="display:none;">
    <div class="raci-header">
      <h2>RACI Matrix</h2>
      <div class="raci-actions">
        <button class="btn btn-secondary" id="add-task-btn">+ Add Task</button>
        <button class="btn btn-secondary" id="add-role-btn">+ Add Role</button>
        <button class="btn btn-secondary" id="import-risks-btn">Import from Risks</button>
      </div>
    </div>

    <div class="raci-table-wrapper">
      <table class="raci-table" id="raci-table">
        <thead id="raci-thead"></thead>
        <tbody id="raci-tbody"></tbody>
      </table>
    </div>
    <div class="raci-legend">
      <div class="legend-item">
        <span class="raci-badge raci-r">R</span>
        <div class="legend-text">
          <strong>Responsible</strong>
          <span>Does the work. The person or role that performs the task or activity.</span>
        </div>
      </div>
      <div class="legend-item">
        <span class="raci-badge raci-a">A</span>
        <div class="legend-text">
          <strong>Accountable</strong>
          <span>Owns the outcome. The single decision-maker who approves and is ultimately answerable.</span>
        </div>
      </div>
      <div class="legend-item">
        <span class="raci-badge raci-c">C</span>
        <div class="legend-text">
          <strong>Consulted</strong>
          <span>Provides input. Subject-matter experts whose feedback is sought before action.</span>
        </div>
      </div>
      <div class="legend-item">
        <span class="raci-badge raci-i">I</span>
        <div class="legend-text">
          <strong>Informed</strong>
          <span>Kept in the loop. Stakeholders who are notified of progress or decisions after the fact.</span>
        </div>
      </div>
    </div>
  </section>

  <!-- COMPANY PROFILE VIEW -->
  <section class="company-view" id="company-view" style="display:none;">

    <!-- Hero Section -->
    <div class="company-hero">
      <div class="company-hero-content">
        <div class="company-hero-tagline">Consumer Robotics &amp; Automation</div>
        <h2>HomeSphere Robotics</h2>
        <p class="company-hero-desc">Designing humanoid and home-automation robots for household assistance, elder care, and personal productivity.</p>
        <div class="company-hero-stats">
          <div class="company-hero-stat">
            <span class="stat-val">2020</span>
            <span class="stat-lbl">Founded</span>
          </div>
          <div class="company-hero-stat">
            <span class="stat-val">1,050</span>
            <span class="stat-lbl">Employees</span>
          </div>
          <div class="company-hero-stat">
            <span class="stat-val">Palo Alto</span>
            <span class="stat-lbl">Headquarters, CA</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Founding Story & Mission -->
    <div class="company-section">
      <h3>Founding Story &amp; Mission</h3>
      <p>Founded in 2020 by a former robotics lead from a major tech company, HomeSphere Robotics set out to transform the relationship between humans and machines in everyday environments.</p>
      <div class="company-mission-block">
        <p>Our mission is to bring safe, affordable robotics into everyday homes and workplaces.</p>
      </div>
    </div>

    <!-- Product Portfolio -->
    <div class="company-section">
      <h3>Product Portfolio</h3>
      <div class="company-grid">
        <div class="company-product-card">
          <span class="product-icon">&#129302;</span>
          <h4>Home Assistant Robot</h4>
          <p>A humanoid robot designed for general household assistance, task management, and daily support.</p>
        </div>
        <div class="company-product-card">
          <span class="product-icon">&#128105;&#8205;&#9877;&#65039;</span>
          <h4>Elder-Care Monitoring Robot</h4>
          <p>Specialized monitoring and response system for elderly care, providing safety oversight and emergency detection.</p>
        </div>
        <div class="company-product-card">
          <span class="product-icon">&#127968;</span>
          <h4>Household Automation Platform</h4>
          <p>Comprehensive smart-home integration platform for seamless control of connected devices and automation routines.</p>
        </div>
        <div class="company-product-card">
          <span class="product-icon">&#128187;</span>
          <h4>Robotics SDK</h4>
          <p>Developer toolkit enabling third-party integration and custom application development on the HomeSphere platform.</p>
        </div>
      </div>
    </div>

    <!-- Organizational Structure -->
    <div class="company-section">
      <h3>Organizational Structure</h3>
      <p style="margin-bottom: 8px; font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary);">Departments</p>
      <div class="company-dept-grid">
        <div class="company-dept-item">Robotics Engineering</div>
        <div class="company-dept-item">AI Systems</div>
        <div class="company-dept-item">Manufacturing</div>
        <div class="company-dept-item">Customer Experience</div>
        <div class="company-dept-item">Safety &amp; Compliance</div>
      </div>
      <p style="margin-bottom: 8px; font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary);">Key Roles</p>
      <div class="company-roles-list">
        <div class="company-role-item">
          <div class="role-dot"></div>
          <span>Chief Robotics Officer</span>
        </div>
        <div class="company-role-item">
          <div class="role-dot"></div>
          <span>VP of AI Systems</span>
        </div>
        <div class="company-role-item">
          <div class="role-dot"></div>
          <span>Head of Safety Engineering</span>
        </div>
        <div class="company-role-item">
          <div class="role-dot"></div>
          <span>Director of Manufacturing</span>
        </div>
      </div>
    </div>

    <!-- Technology & Infrastructure -->
    <div class="company-section">
      <h3>Technology &amp; Infrastructure</h3>
      <p style="margin-bottom: 12px;">HomeSphere operates on a vertically integrated technology stack spanning custom hardware through cloud services.</p>
      <div class="company-tags">
        <span class="company-tag">Custom Robotics Hardware</span>
        <span class="company-tag">Multimodal AI Models</span>
        <span class="company-tag">Real-Time Motion Planning</span>
        <span class="company-tag">Cloud Device Management</span>
      </div>
      <div class="company-mfg-note">
        <span style="font-size: 1.2rem;">&#127981;</span>
        <span>Manufacturing split between <strong>California, USA</strong> and <strong>Vietnam</strong></span>
      </div>
    </div>

    <!-- Market Position -->
    <div class="company-section">
      <h3>Market Position &amp; Competitive Landscape</h3>
      <div class="company-differentiator">
        <span style="font-size: 1.3rem; flex-shrink: 0;">&#9989;</span>
        <p>HomeSphere differentiates through <strong>safety-first design</strong> and <strong>strong integration with smart-home ecosystems</strong>.</p>
      </div>
      <p style="margin-bottom: 8px; font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary);">Key Competitors</p>
      <div class="company-tags">
        <span class="company-tag neutral">Figure AI</span>
        <span class="company-tag neutral">Agility Robotics</span>
        <span class="company-tag neutral">Emerging Consumer Robotics Startups</span>
      </div>
    </div>

    <!-- Risk & Compliance Maturity -->
    <div class="company-section">
      <h3>Risk, Security &amp; Compliance Maturity</h3>
      <div class="company-maturity-grid">
        <div class="company-maturity-item">
          <span class="maturity-label">Safety Engineering</span>
          <div class="maturity-status mature">
            <span class="maturity-dot green"></span>
            Mature
          </div>
        </div>
        <div class="company-maturity-item">
          <span class="maturity-label">Cybersecurity</span>
          <div class="maturity-status developing">
            <span class="maturity-dot orange"></span>
            Developing
          </div>
        </div>
        <div class="company-maturity-item">
          <span class="maturity-label">Privacy Governance</span>
          <div class="maturity-status developing">
            <span class="maturity-dot orange"></span>
            Developing
          </div>
        </div>
        <div class="company-maturity-item">
          <span class="maturity-label">Robotics Safety Standards</span>
          <div class="maturity-status developing">
            <span class="maturity-dot orange"></span>
            Ongoing Compliance
          </div>
        </div>
      </div>
    </div>

    <!-- Operational Dependencies -->
    <div class="company-section">
      <h3>Operational Dependencies</h3>
      <div class="company-deps-list">
        <div class="company-dep-item">
          <span class="dep-icon">&#9881;&#65039;</span>
          Robotics Component Suppliers
        </div>
        <div class="company-dep-item">
          <span class="dep-icon">&#9729;&#65039;</span>
          Cloud Connectivity
        </div>
        <div class="company-dep-item">
          <span class="dep-icon">&#128259;</span>
          Firmware Updates
        </div>
        <div class="company-dep-item">
          <span class="dep-icon">&#127758;</span>
          Global Logistics
        </div>
        <div class="company-dep-item">
          <span class="dep-icon">&#128269;</span>
          Real-Time Diagnostics
        </div>
        <div class="company-dep-item">
          <span class="dep-icon">&#127897;&#65039;</span>
          Remote Troubleshooting
        </div>
      </div>
    </div>

    <!-- Challenges & Opportunities -->
    <div class="company-section">
      <h3>Challenges &amp; Opportunities</h3>
      <div class="company-challenges-grid">
        <div class="company-challenges-col">
          <h4>&#9888;&#65039; Known Challenges</h4>
          <ul>
            <li>
              <span class="ch-icon">&#9888;&#65039;</span>
              Ensuring safety in human-robot interaction
            </li>
            <li>
              <span class="ch-icon">&#128274;</span>
              Managing privacy risks from in-home sensors
            </li>
            <li>
              <span class="ch-icon">&#127981;</span>
              Scaling manufacturing capacity
            </li>
          </ul>
        </div>
        <div class="company-challenges-col">
          <h4>&#128640; Opportunities</h4>
          <ul>
            <li>
              <span class="ch-icon">&#128640;</span>
              Expand into elder-care market
            </li>
            <li>
              <span class="ch-icon">&#128640;</span>
              Workplace automation adoption
            </li>
          </ul>
        </div>
      </div>
    </div>

  </section>

  <!-- DETAIL PANEL -->
  <div class="detail-backdrop" id="detail-backdrop"></div>
  <aside class="detail-panel" id="detail-panel">
    <div class="detail-header">
      <div class="detail-header-info">
        <h2 id="detail-title"></h2>
        <div class="detail-meta" id="detail-meta"></div>
      </div>
      <button class="close-btn" id="detail-close" aria-label="Close panel">&times;</button>
    </div>
    <div class="detail-body" id="detail-body"></div>
  </aside>

  <!-- ADD RISK MODAL -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" id="risk-modal">
      <div class="modal-header">
        <h2>Add New Risk</h2>
        <button class="close-btn" id="modal-close" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="fg-title">
          <label for="risk-title">Risk Title</label>
          <input type="text" id="risk-title" placeholder="Enter risk title" maxlength="100">
          <div class="form-error">Title is required.</div>
        </div>
        <div class="form-group" id="fg-desc">
          <label for="risk-desc">Description</label>
          <textarea id="risk-desc" placeholder="Describe the risk..." maxlength="500"></textarea>
          <div class="form-error">Description is required.</div>
        </div>
        <!-- Likelihood Section -->
        <div class="likelihood-section">
          <div class="section-header">
            <h3>Likelihood</h3>
            <span class="section-badge" id="badge-likelihood">Not Selected</span>
          </div>
          <table class="rubric-table" id="likelihood-table">
            <thead>
              <tr>
                <th>Rating</th>
                <th>Probability of Occurring</th>
                <th>Criteria</th>
              </tr>
            </thead>
            <tbody id="likelihood-tbody"></tbody>
          </table>
          <input type="hidden" id="risk-likelihood">
          <div class="form-error" id="err-likelihood" style="display:none;">Please select a likelihood score.</div>
        </div>

        <!-- Likelihood Justification -->
        <div class="form-group" id="fg-lik-justification" style="margin-top:10px;">
          <label for="risk-lik-justification">Likelihood Justification</label>
          <textarea id="risk-lik-justification" placeholder="Explain why this likelihood rating was chosen..." maxlength="1000"></textarea>
        </div>

        <!-- Impact Section -->
        <div class="impact-section" style="margin-top:20px;">
          <div class="section-header">
            <h3>Impact Calculator</h3>
            <span class="section-badge" id="badge-impact">Not Calculated</span>
          </div>

          <!-- Note: Weights are configured in Settings -->

          <table class="rubric-table impact-rubric-table" id="impact-table">
            <thead>
              <tr>
                <th>Rating</th>
                <th>Trust or Reputational</th>
                <th>Operational Scope</th>
                <th>Legal, Compliance, or Environmental</th>
                <th>Enterprise Value</th>
              </tr>
            </thead>
            <tbody id="impact-tbody"></tbody>
          </table>

          <!-- Impact Justification -->
          <div class="form-group" id="fg-imp-justification" style="margin-top:10px;">
            <label for="risk-imp-justification">Impact Justification</label>
            <textarea id="risk-imp-justification" placeholder="Explain why this impact rating was chosen..." maxlength="1000"></textarea>
          </div>

          <div class="score-summary-container">
            <div class="score-row impact-row">
              <div class="score-info">
                <span class="score-type">Impact Score</span>
                <span class="score-calc" id="calc-formula">Select all categories</span>
              </div>
              <div class="score-result">
                <span class="score-value" id="raw-score"></span>
                <span class="score-badge-lg" id="final-score">?</span>
              </div>
            </div>
            <div class="score-divider"></div>
            <div class="score-row risk-row">
              <div class="score-info">
                <span class="score-type">Total Risk Score</span>
                <span class="score-calc" id="risk-formula">Likelihood  Impact</span>
              </div>
              <div class="score-result">
                <span class="score-badge-xl" id="total-risk-score">?</span>
              </div>
            </div>
          </div>
          <input type="hidden" id="risk-impact">
          <div class="form-error" id="err-impact" style="display:none;">Please select an impact level for each category.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-save">Save Risk</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-backdrop" id="settings-backdrop">
    <div class="modal" id="settings-modal" style="max-width: 720px;">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="close-btn" id="settings-close" aria-label="Close settings">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="settings-appetite">Risk Appetite Threshold</label>
          <p style="font-size:0.8rem; color:var(--color-text-secondary); margin-bottom:10px;">
            Scores above this threshold are considered "Outside Appetite"
          </p>
          <select id="settings-appetite" style="width:100%;">
            <!-- Will be populated by JS -->
          </select>
        </div>

        <hr style="border:none; border-top:1px solid var(--color-border); margin:20px 0;">

        <div class="form-group">
          <label>Impact Category Weights</label>
          <p style="font-size:0.8rem; color:var(--color-text-secondary); margin-bottom:12px;">
            Set the relative importance of each impact category. Weights are used to calculate the weighted average
            impact score.
          </p>
          <div class="settings-weights">
            <div class="settings-weight-item">
              <label>Trust / Reputational</label>
              <div class="weight-input-group">
                <input type="number" id="settings-w-trust" value="25" min="0" max="100">
                <span>%</span>
              </div>
            </div>
            <div class="settings-weight-item">
              <label>Operational Scope</label>
              <div class="weight-input-group">
                <input type="number" id="settings-w-ops" value="25" min="0" max="100">
                <span>%</span>
              </div>
            </div>
            <div class="settings-weight-item">
              <label>Legal / Compliance / Environmental</label>
              <div class="weight-input-group">
                <input type="number" id="settings-w-legal" value="25" min="0" max="100">
                <span>%</span>
              </div>
            </div>
            <div class="settings-weight-item">
              <label>Enterprise Value</label>
              <div class="weight-input-group">
                <input type="number" id="settings-w-val" value="25" min="0" max="100">
                <span>%</span>
              </div>
            </div>
          </div>
          <div class="weight-total" id="weight-total-display">
            Total: <strong>100%</strong>
          </div>
        </div>

        <hr style="border:none; border-top:1px solid var(--color-border); margin:20px 0;">

        <!-- Likelihood Scale Editor -->
        <div class="form-group">
          <div class="rubric-editor-header">
            <label>Likelihood Scale</label>
            <button type="button" class="btn btn-secondary btn-sm" id="reset-likelihood-rubric">Reset to Defaults</button>
          </div>
          <p style="font-size:0.8rem; color:var(--color-text-secondary); margin-bottom:12px;">
            Edit the probability ranges and criteria descriptions for each likelihood level.
          </p>
          <div class="rubric-editor" id="likelihood-editor">
            <!-- Rendered by JS -->
          </div>
        </div>

        <hr style="border:none; border-top:1px solid var(--color-border); margin:20px 0;">

        <!-- Impact Scale Editor -->
        <div class="form-group">
          <div class="rubric-editor-header">
            <label>Impact Scale</label>
            <button type="button" class="btn btn-secondary btn-sm" id="reset-impact-rubric">Reset to Defaults</button>
          </div>
          <p style="font-size:0.8rem; color:var(--color-text-secondary); margin-bottom:12px;">
            Edit the category descriptions for each impact level.
          </p>
          <div class="rubric-editor" id="impact-editor">
            <!-- Rendered by JS -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="settings-cancel">Cancel</button>
        <button class="btn btn-primary" id="settings-save">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- ADD TASK MODAL (RACI) -->
  <div class="modal-backdrop" id="task-modal-backdrop">
    <div class="modal" id="task-modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Add Task</h2>
        <button class="close-btn" id="task-modal-close" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="fg-task-name">
          <label for="task-name">Task / Risk Name</label>
          <input type="text" id="task-name" placeholder="Enter task or risk name" maxlength="200">
          <div class="form-error">Task name is required.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="task-modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="task-modal-save">Add Task</button>
      </div>
    </div>
  </div>

  <!-- ADD ROLE MODAL (RACI) -->
  <div class="modal-backdrop" id="role-modal-backdrop">
    <div class="modal" id="role-modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Add Role</h2>
        <button class="close-btn" id="role-modal-close" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="fg-role-name">
          <label for="role-name">Role Name</label>
          <input type="text" id="role-name" placeholder="Enter role name" maxlength="100">
          <div class="form-error">Role name is required.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="role-modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="role-modal-save">Add Role</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONSTANTS =====
    const LIKELIHOOD_LABELS = [
      'Remote',
      'Not Likely',
      'Likely',
      'Highly Likely',
      'Expected'
    ];

    const IMPACT_LABELS = [
      'Minimal',
      'Low',
      'Moderate',
      'High',
      'Critical'
    ];

    const DEFAULT_LIKELIHOOD_RUBRIC = [
      { score: 5, rating: 'Expected', prob: '90-100%', criteria: 'With certainty, the event is expected to occur.' },
      { score: 4, rating: 'Highly Likely', prob: '60-90%', criteria: 'There is a high chance of this event occurring.' },
      { score: 3, rating: 'Likely', prob: '35-60%', criteria: 'The risk event or circumstance is likely to occur.' },
      { score: 2, rating: 'Not Likely', prob: '5-35%', criteria: 'The risk event or circumstance occurring is possible but not likely.' },
      { score: 1, rating: 'Remote', prob: '<5%', criteria: 'There is a rare chance of the risk event or circumstance occurring.' }
    ];

    const DEFAULT_IMPACT_RUBRIC = [
      {
        score: 5, rating: 'Critical',
        trust: 'Permanent loss of stakeholder trust. Failure to meet SLA for 15% of users, subscribers, and members.',
        ops: 'Impacts the business operations of the enterprise globally.',
        legal: 'Global restrictions on conducting business in certain product lines, markets, or geographies.',
        val: 'Financial Impact > $3B (10% of Company Value)'
      },
      {
        score: 4, rating: 'High',
        trust: 'Great loss of stakeholder trust. Failure to meet SLA for 10% of users, subscribers, and members.',
        ops: 'Significantly impacts business operations for multiple business areas.',
        legal: 'Prohibited from conducting business in certain key product lines, markets, or geographies.',
        val: 'Financial Impact > $600M (2% of the Company Value)'
      },
      {
        score: 3, rating: 'Moderate',
        trust: 'Moderate loss of stakeholder trust. Failure to meet SLA for 5% of users, subscribers, and members.',
        ops: 'Impacts the business operations for a few business areas.',
        legal: 'Moderate limitations on conducting business in some product lines, markets, or geographies.',
        val: 'Financial Impact > $150M'
      },
      {
        score: 2, rating: 'Low',
        trust: 'Small loss of stakeholder trust. Failure to meet SLA for 2% of users, subscribers, and members.',
        ops: 'Limited impact on business operations for a few business areas.',
        legal: 'Some limitations on conducting business within a few product lines, markets, and a region.',
        val: 'Financial Impact > $30M'
      },
      {
        score: 1, rating: 'Minimal',
        trust: 'Minimal loss of stakeholder trust. Failure to meet SLA for less than 2% of users, subscribers, and members.',
        ops: 'Minimal impact on business operations within a single business area.',
        legal: 'Minimal limitations on conducting business within a product line, market, or region.',
        val: 'Financial Impact < $5M'
      }
    ];

    // Mutable rubric state (initialized from defaults, overridden by saved data)
    let likelihoodRubric = JSON.parse(JSON.stringify(DEFAULT_LIKELIHOOD_RUBRIC));
    let impactRubric = JSON.parse(JSON.stringify(DEFAULT_IMPACT_RUBRIC));

    const STORAGE_KEY = 'riskHeatMapData';
    const APPETITE_KEY = 'riskAppetiteThreshold';
    const RUBRIC_KEY = 'risk_rubric_data';
    const RACI_KEY = 'raci_matrix_data';
    const DEFAULT_APPETITE = 12;

    // RACI Constants
    const RACI_VALUES = ['', 'R', 'A', 'C', 'I'];
    const DEFAULT_RACI_DATA = {
      version: 3,
      roles: [
        { id: 'role_1', name: 'Board/Committee' },
        { id: 'role_2', name: 'CEO (Exec Leadership)' },
        { id: 'role_3', name: 'Safety/QA' },
        { id: 'role_4', name: 'Legal/Compliance' },
        { id: 'role_5', name: 'Hardware Engineering' },
        { id: 'role_6', name: 'Software Engineers' },
        { id: 'role_7', name: 'Product Manager' },
        { id: 'role_8', name: 'PR' },
        { id: 'role_9', name: 'ERM Function' },
        { id: 'role_10', name: 'Customer Experience' },
        { id: 'role_11', name: 'Internal Audit' }
      ],
      tasks: [
        { id: 'task_1', name: 'Unintended Robot Actions' },
        { id: 'task_2', name: 'Elderly Care robot fails to detect/respond' },
        { id: 'task_3', name: 'HIPAA Violation' },
        { id: 'task_4', name: 'Account Data Breach' },
        { id: 'task_5', name: 'Cloud Service Outage' }
      ],
      assignments: {
        // Unintended Robot Actions: I, A, C, C, R, C, C, I, C, C, I
        'task_1_role_1': 'I', 'task_1_role_2': 'A', 'task_1_role_3': 'C', 'task_1_role_4': 'C',
        'task_1_role_5': 'R', 'task_1_role_6': 'C', 'task_1_role_7': 'C', 'task_1_role_8': 'I',
        'task_1_role_9': 'C', 'task_1_role_10': 'C', 'task_1_role_11': 'I',
        // Elderly Care robot fails to detect/respond: I, A, C, C, C, R, C, I, C, C, I
        'task_2_role_1': 'I', 'task_2_role_2': 'A', 'task_2_role_3': 'C', 'task_2_role_4': 'C',
        'task_2_role_5': 'C', 'task_2_role_6': 'R', 'task_2_role_7': 'C', 'task_2_role_8': 'I',
        'task_2_role_9': 'C', 'task_2_role_10': 'C', 'task_2_role_11': 'I',
        // HIPAA Violation: I, A, C, R, I, C, C, C, C, I, I
        'task_3_role_1': 'I', 'task_3_role_2': 'A', 'task_3_role_3': 'C', 'task_3_role_4': 'R',
        'task_3_role_5': 'I', 'task_3_role_6': 'C', 'task_3_role_7': 'C', 'task_3_role_8': 'C',
        'task_3_role_9': 'C', 'task_3_role_10': 'I', 'task_3_role_11': 'I',
        // Account Data Breach: I, A, I, C, I, R, C, I, C, C, I
        'task_4_role_1': 'I', 'task_4_role_2': 'A', 'task_4_role_3': 'I', 'task_4_role_4': 'C',
        'task_4_role_5': 'I', 'task_4_role_6': 'R', 'task_4_role_7': 'C', 'task_4_role_8': 'I',
        'task_4_role_9': 'C', 'task_4_role_10': 'C', 'task_4_role_11': 'I',
        // Cloud Service Outage: I, A, I, I, I, R, C, I, C, C, I
        'task_5_role_1': 'I', 'task_5_role_2': 'A', 'task_5_role_3': 'I', 'task_5_role_4': 'I',
        'task_5_role_5': 'I', 'task_5_role_6': 'R', 'task_5_role_7': 'C', 'task_5_role_8': 'I',
        'task_5_role_9': 'C', 'task_5_role_10': 'C', 'task_5_role_11': 'I'
      }
    };

    function getColorForScore(score) {
      if (score >= 13) return { bg: '#ef4444', text: '#ffffff', level: 'Critical' };
      if (score >= 7) return { bg: '#f97316', text: '#ffffff', level: 'High' };
      if (score >= 4) return { bg: '#eab308', text: '#1e293b', level: 'Medium' };
      return { bg: '#22c55e', text: '#ffffff', level: 'Low' };
    }

    // ===== STATE =====
    let risks = [];
    let appetiteThreshold = DEFAULT_APPETITE;
    let currentDetailCell = null;
    let editingRiskId = null; // null = adding new, string = editing existing

    // Impact Calculator State
    let impactScores = { trust: 0, ops: 0, legal: 0, val: 0 };
    let impactWeights = { trust: 25, ops: 25, legal: 25, val: 25 };

    // RACI State
    let raciMatrix = JSON.parse(JSON.stringify(DEFAULT_RACI_DATA));
    let currentView = 'heatmap';
    let editingTaskId = null;
    let editingRoleId = null;

    // ===== FIREBASE SETUP =====
    let db = null;
    let firebaseInitialized = false;

    function initFirebase() {
      try {
        if (window.firebaseConfig && window.firebaseConfig.apiKey !== 'YOUR_API_KEY') {
          firebase.initializeApp(window.firebaseConfig);
          db = firebase.database();
          firebaseInitialized = true;
          console.log('Firebase initialized successfully');
          return true;
        } else {
          console.warn('Firebase config not set - using localStorage fallback');
          return false;
        }
      } catch (e) {
        console.warn('Failed to initialize Firebase:', e);
        return false;
      }
    }

    // ===== PERSISTENCE (Firebase with localStorage fallback) =====
    function setupRealtimeListeners() {
      if (!firebaseInitialized) return;

      // Listen for risks changes
      db.ref('risks').on('value', (snapshot) => {
        const data = snapshot.val();
        risks = data ? Object.values(data) : [];
        renderGrid();
        renderStats();
        if (currentDetailCell) {
          openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
        }
      }, (error) => {
        console.error('Firebase Read Error (Risks):', error.message);
        if (error.message.includes('permission_denied')) {
          console.warn('Check your Firebase Realtime Database Security Rules!');
        }
      });

      // Listen for settings changes
      db.ref('settings').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          if (data.appetiteThreshold) {
            appetiteThreshold = data.appetiteThreshold;
          }
          if (data.weights) {
            impactWeights = {
              trust: data.weights.trust || 25,
              ops: data.weights.ops || 25,
              legal: data.weights.legal || 25,
              val: data.weights.val || 25
            };
            recalculateRiskImpacts();
          }
          if (data.rubricData) {
            if (data.rubricData.likelihood && Array.isArray(data.rubricData.likelihood) && data.rubricData.likelihood.length === 5) {
              likelihoodRubric = data.rubricData.likelihood;
            }
            if (data.rubricData.impact && Array.isArray(data.rubricData.impact) && data.rubricData.impact.length === 5) {
              impactRubric = data.rubricData.impact;
            }
          }
          renderGrid();
          renderStats();
        }
      }, (error) => {
        console.error('Firebase Read Error (Settings):', error.message);
      });

      // Listen for RACI matrix changes
      db.ref('raciMatrix').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.roles && data.tasks && data.assignments) {
          // Only accept Firebase data if it matches the current default version
          if (data.version === DEFAULT_RACI_DATA.version) {
            raciMatrix = data;
            if (currentView === 'raci') {
              renderRaciTable();
            }
          } else {
            // Firebase has stale data  push the current defaults up to Firebase
            raciMatrix = JSON.parse(JSON.stringify(DEFAULT_RACI_DATA));
            saveRaciData();
          }
        }
      }, (error) => {
        console.error('Firebase Read Error (RACI):', error.message);
      });
    }

    function loadRisks() {
      // Initial load from localStorage as fallback
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (Array.isArray(parsed)) return parsed;
        }
      } catch (e) {
        console.warn('Failed to load risks from localStorage:', e);
      }
      return [];
    }

    function saveRisks() {
      // Save to localStorage as backup
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(risks));
      } catch (e) {
        console.warn('Failed to save risks to localStorage:', e);
      }

      // Save to Firebase
      if (firebaseInitialized) {
        const risksObj = {};
        risks.forEach(r => { risksObj[r.id] = r; });
        db.ref('risks').set(risksObj).catch(e => {
          console.warn('Failed to save risks to Firebase:', e);
        });
      }
    }

    function deleteRiskFromFirebase(riskId) {
      if (firebaseInitialized) {
        db.ref('risks/' + riskId).remove().catch(e => {
          console.warn('Failed to delete risk from Firebase:', e);
        });
      }
    }

    function loadAppetite() {
      try {
        const val = localStorage.getItem(APPETITE_KEY);
        if (val !== null) {
          const num = parseInt(val, 10);
          if (num >= 1 && num <= 25) return num;
        }
      } catch (e) {
        console.warn('Failed to load appetite:', e);
      }
      return DEFAULT_APPETITE;
    }

    function saveAppetite() {
      try {
        localStorage.setItem(APPETITE_KEY, String(appetiteThreshold));
      } catch (e) {
        console.warn('Failed to save appetite:', e);
      }

      if (firebaseInitialized) {
        db.ref('settings/appetiteThreshold').set(appetiteThreshold).catch(e => {
          console.warn('Failed to save appetite to Firebase:', e);
        });
      }
    }

    const WEIGHTS_KEY = 'risk_weights';

    function loadWeights() {
      try {
        const data = localStorage.getItem(WEIGHTS_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed && typeof parsed === 'object') {
            return {
              trust: parsed.trust || 25,
              ops: parsed.ops || 25,
              legal: parsed.legal || 25,
              val: parsed.val || 25
            };
          }
        }
      } catch (e) {
        console.warn('Failed to load weights:', e);
      }
      return { trust: 25, ops: 25, legal: 25, val: 25 };
    }

    function saveWeights() {
      try {
        localStorage.setItem(WEIGHTS_KEY, JSON.stringify(impactWeights));
      } catch (e) {
        console.warn('Failed to save weights:', e);
      }

      if (firebaseInitialized) {
        db.ref('settings/weights').set(impactWeights).catch(e => {
          console.warn('Failed to save weights to Firebase:', e);
        });
      }
    }

    // ===== RUBRIC DATA PERSISTENCE =====
    function loadRubricData() {
      try {
        const data = localStorage.getItem(RUBRIC_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed && parsed.likelihood && Array.isArray(parsed.likelihood) && parsed.likelihood.length === 5) {
            likelihoodRubric = parsed.likelihood;
          }
          if (parsed && parsed.impact && Array.isArray(parsed.impact) && parsed.impact.length === 5) {
            impactRubric = parsed.impact;
          }
        }
      } catch (e) {
        console.warn('Failed to load rubric data:', e);
      }
    }

    function saveRubricData() {
      const data = { likelihood: likelihoodRubric, impact: impactRubric };
      try {
        localStorage.setItem(RUBRIC_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn('Failed to save rubric data:', e);
      }

      if (firebaseInitialized) {
        db.ref('settings/rubricData').set(data).catch(e => {
          console.warn('Failed to save rubric data to Firebase:', e);
        });
      }
    }

    // ===== RACI PERSISTENCE =====
    function loadRaciData() {
      try {
        const data = localStorage.getItem(RACI_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed && parsed.roles && parsed.tasks && parsed.assignments) {
            if (parsed.version === DEFAULT_RACI_DATA.version) {
              return parsed;
            }
          }
        }
      } catch (e) {
        console.warn('Failed to load RACI data from localStorage:', e);
      }
      return JSON.parse(JSON.stringify(DEFAULT_RACI_DATA));
    }

    function saveRaciData() {
      try {
        localStorage.setItem(RACI_KEY, JSON.stringify(raciMatrix));
      } catch (e) {
        console.warn('Failed to save RACI data to localStorage:', e);
      }

      if (firebaseInitialized) {
        db.ref('raciMatrix').set(raciMatrix).catch(e => {
          console.warn('Failed to save RACI data to Firebase:', e);
        });
      }
    }

    function generateId() {
      return 'r_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
    }

    // ===== GRID RENDERING =====
    function getRisksForCell(likelihood, impact) {
      return risks.filter(r => r.likelihood === likelihood && r.impact === impact);
    }

    function renderGrid() {
      const grid = document.getElementById('heatmap-grid');
      grid.innerHTML = '';

      // Build a score map for appetite boundary detection
      const scoreMap = {};
      for (let imp = 1; imp <= 5; imp++) {
        for (let lik = 1; lik <= 5; lik++) {
          scoreMap[`${lik},${imp}`] = lik * imp;
        }
      }

      // Rows: impact 5 (top) to impact 1 (bottom)
      for (let imp = 5; imp >= 1; imp--) {
        // Y-axis label
        const yLabel = document.createElement('div');
        yLabel.className = 'y-label';
        yLabel.textContent = IMPACT_LABELS[imp - 1];
        grid.appendChild(yLabel);

        // Cells for this row
        for (let lik = 1; lik <= 5; lik++) {
          const score = lik * imp;
          const color = getColorForScore(score);
          const cellRisks = getRisksForCell(lik, imp);
          const count = cellRisks.length;
          const isOutside = score > appetiteThreshold;

          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';
          cell.setAttribute('role', 'button');
          cell.setAttribute('tabindex', '0');
          cell.setAttribute('data-likelihood', lik);
          cell.setAttribute('data-impact', imp);
          cell.setAttribute('aria-label',
            `Likelihood: ${LIKELIHOOD_LABELS[lik - 1]}, Impact: ${IMPACT_LABELS[imp - 1]}, ` +
            `Score: ${score}, ${count} risk${count !== 1 ? 's' : ''}, ${color.level} risk`
          );
          cell.style.backgroundColor = color.bg;
          cell.style.color = color.text;

          if (isOutside) {
            cell.classList.add('outside-appetite');
          }

          // Appetite boundary borders
          // Check neighbor above (imp + 1): if current is outside and above is within (or no neighbor)
          // We draw the border on the edge between within and outside cells
          if (imp < 5) {
            const neighborAboveScore = scoreMap[`${lik},${imp + 1}`];
            const neighborAboveOutside = neighborAboveScore > appetiteThreshold;
            if (isOutside !== neighborAboveOutside) {
              if (isOutside) {
                cell.classList.add('appetite-border-top');
              } else {
                // This cell is within, the one above is outside  no top border needed here,
                // the cell above handles its bottom border
              }
            }
          } else if (isOutside) {
            // Top row and outside: add top border
            cell.classList.add('appetite-border-top');
          }

          if (imp > 1) {
            const neighborBelowScore = scoreMap[`${lik},${imp - 1}`];
            const neighborBelowOutside = neighborBelowScore > appetiteThreshold;
            if (isOutside !== neighborBelowOutside) {
              if (isOutside) {
                cell.classList.add('appetite-border-bottom');
              }
            }
          } else if (isOutside) {
            cell.classList.add('appetite-border-bottom');
          }

          if (lik > 1) {
            const neighborLeftScore = scoreMap[`${lik - 1},${imp}`];
            const neighborLeftOutside = neighborLeftScore > appetiteThreshold;
            if (isOutside !== neighborLeftOutside) {
              if (isOutside) {
                cell.classList.add('appetite-border-left');
              }
            }
          } else if (isOutside) {
            cell.classList.add('appetite-border-left');
          }

          if (lik < 5) {
            const neighborRightScore = scoreMap[`${lik + 1},${imp}`];
            const neighborRightOutside = neighborRightScore > appetiteThreshold;
            if (isOutside !== neighborRightOutside) {
              if (isOutside) {
                cell.classList.add('appetite-border-right');
              }
            }
          } else if (isOutside) {
            cell.classList.add('appetite-border-right');
          }

          const countSpan = document.createElement('span');
          countSpan.className = 'cell-count' + (count === 0 ? ' empty' : '');
          countSpan.textContent = count;
          cell.appendChild(countSpan);

          grid.appendChild(cell);
        }
      }

      // Bottom row: corner spacer + X-axis labels
      const spacer = document.createElement('div');
      spacer.className = 'corner-spacer';
      grid.appendChild(spacer);

      for (let lik = 1; lik <= 5; lik++) {
        const xLabel = document.createElement('div');
        xLabel.className = 'x-label';
        xLabel.textContent = LIKELIHOOD_LABELS[lik - 1];
        grid.appendChild(xLabel);
      }

      // Empty hint
      const hint = document.getElementById('empty-hint');
      hint.style.display = risks.length === 0 ? 'block' : 'none';
    }

    function renderStats() {
      let total = risks.length;
      let critical = 0;
      let high = 0;
      let mediumLow = 0;
      let outsideAppetite = 0;

      risks.forEach(r => {
        const score = r.likelihood * r.impact;
        if (score >= 13) critical++;
        else if (score >= 7) high++;
        else mediumLow++;

        if (score > appetiteThreshold) outsideAppetite++;
      });

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-critical').textContent = critical;
      document.getElementById('stat-high').textContent = high;
      document.getElementById('stat-medium').textContent = mediumLow;
      document.getElementById('stat-appetite').textContent = outsideAppetite;
    }

    // ===== DETAIL PANEL =====
    function openDetail(likelihood, impact) {
      currentDetailCell = { likelihood, impact };
      const panel = document.getElementById('detail-panel');
      const backdrop = document.getElementById('detail-backdrop');
      const titleEl = document.getElementById('detail-title');
      const metaEl = document.getElementById('detail-meta');
      const bodyEl = document.getElementById('detail-body');

      const score = likelihood * impact;
      const color = getColorForScore(score);
      const isOutside = score > appetiteThreshold;

      titleEl.textContent = `${LIKELIHOOD_LABELS[likelihood - 1]} / ${IMPACT_LABELS[impact - 1]}`;

      // Build meta HTML safely
      metaEl.textContent = '';
      const scoreText = document.createTextNode('Score: ' + score + ' ');
      metaEl.appendChild(scoreText);

      const badge = document.createElement('span');
      badge.className = 'score-badge';
      badge.style.backgroundColor = color.bg;
      badge.textContent = color.level;
      metaEl.appendChild(badge);

      const appetiteBadge = document.createElement('span');
      appetiteBadge.className = 'appetite-badge ' + (isOutside ? 'outside' : 'within');
      appetiteBadge.textContent = isOutside ? 'Outside Appetite' : 'Within Appetite';
      metaEl.appendChild(appetiteBadge);

      // Render risks as expandable cards
      const cellRisks = getRisksForCell(likelihood, impact);
      bodyEl.textContent = '';

      if (cellRisks.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'detail-empty';
        empty.textContent = 'No risks at this level.';
        bodyEl.appendChild(empty);
      } else {
        cellRisks.forEach(risk => {
          const card = document.createElement('div');
          card.className = 'risk-card';
          card.setAttribute('data-risk-id', risk.id);

          // Header (always visible)
          const header = document.createElement('div');
          header.className = 'risk-card-header';

          const h3 = document.createElement('h3');
          h3.textContent = risk.title;
          header.appendChild(h3);

          const expandIcon = document.createElement('span');
          expandIcon.className = 'expand-icon';
          expandIcon.textContent = '';
          header.appendChild(expandIcon);

          card.appendChild(header);

          // Preview (visible when collapsed)
          const preview = document.createElement('div');
          preview.className = 'risk-card-preview';
          preview.textContent = risk.description;
          card.appendChild(preview);

          // Details (visible when expanded)
          const details = document.createElement('div');
          details.className = 'risk-card-details';

          // Description
          details.innerHTML = `
            <div class="risk-detail-row">
              <label>Description</label>
              <div class="value">${escapeHtml(risk.description)}</div>
            </div>
            <div class="risk-detail-row">
              <label>Likelihood</label>
              <div class="value">${LIKELIHOOD_LABELS[risk.likelihood - 1]} (${risk.likelihood})</div>
            </div>
          `;

          // Likelihood Justification (right after Likelihood score)
          if (risk.likelihoodJustification) {
            const likJustRow = document.createElement('div');
            likJustRow.className = 'risk-detail-row';
            likJustRow.innerHTML = `<label>Likelihood Justification</label>`;
            const likJustVal = document.createElement('div');
            likJustVal.className = 'value';
            likJustVal.textContent = risk.likelihoodJustification;
            likJustRow.appendChild(likJustVal);
            details.appendChild(likJustRow);
          }

          // Impact Score row
          const impactScoreRow = document.createElement('div');
          impactScoreRow.className = 'risk-detail-row';
          impactScoreRow.innerHTML = `
            <label>Impact Score</label>
            <div class="value">${IMPACT_LABELS[risk.impact - 1]} (${risk.impact})</div>
          `;
          details.appendChild(impactScoreRow);

          // Impact breakdown if available
          if (risk.impactDetails) {
            const breakdownRow = document.createElement('div');
            breakdownRow.className = 'risk-detail-row';
            breakdownRow.innerHTML = `<label>Impact Breakdown</label>`;

            const breakdown = document.createElement('div');
            breakdown.className = 'impact-breakdown';

            const catNames = { trust: 'Trust', ops: 'Operations', legal: 'Legal', val: 'Value' };
            const weights = risk.impactWeights || { trust: 25, ops: 25, legal: 25, val: 25 };

            ['trust', 'ops', 'legal', 'val'].forEach(cat => {
              if (risk.impactDetails[cat]) {
                const item = document.createElement('div');
                item.className = 'impact-breakdown-item';
                item.innerHTML = `
                  <span class="cat-name">${catNames[cat]}:</span>
                  <span class="cat-score">${risk.impactDetails[cat]}</span>
                  <span style="color:#94a3b8; margin-left:4px;">(${weights[cat]}%)</span>
                `;
                breakdown.appendChild(item);
              }
            });

            breakdownRow.appendChild(breakdown);
            details.appendChild(breakdownRow);
          }

          // Impact Justification (right after Impact Breakdown)
          if (risk.impactJustification) {
            const impJustRow = document.createElement('div');
            impJustRow.className = 'risk-detail-row';
            impJustRow.innerHTML = `<label>Impact Justification</label>`;
            const impJustVal = document.createElement('div');
            impJustVal.className = 'value';
            impJustVal.textContent = risk.impactJustification;
            impJustRow.appendChild(impJustVal);
            details.appendChild(impJustRow);
          }

          // Date
          const dateRow = document.createElement('div');
          dateRow.className = 'risk-detail-row';
          dateRow.innerHTML = `
            <label>Created</label>
            <div class="value">${new Date(risk.createdAt).toLocaleDateString()} at ${new Date(risk.createdAt).toLocaleTimeString()}</div>
          `;
          details.appendChild(dateRow);

          // Actions
          const actions = document.createElement('div');
          actions.className = 'risk-card-actions';

          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-secondary';
          editBtn.textContent = 'Edit';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            openEditModal(risk);
          };
          actions.appendChild(editBtn);

          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-danger';
          delBtn.textContent = 'Delete';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            handleDeleteRisk(risk.id);
          };
          actions.appendChild(delBtn);

          details.appendChild(actions);
          card.appendChild(details);

          // Toggle expand on click
          card.onclick = () => {
            card.classList.toggle('expanded');
          };

          bodyEl.appendChild(card);
        });
      }

      panel.classList.add('active');
      backdrop.classList.add('active');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function closeDetail() {
      currentDetailCell = null;
      document.getElementById('detail-panel').classList.remove('active');
      document.getElementById('detail-backdrop').classList.remove('active');
    }

    // ===== ADD RISK MODAL =====
    function openAddModal() {
      document.getElementById('risk-title').value = '';
      document.getElementById('risk-desc').value = '';
      document.getElementById('risk-likelihood').value = '';
      document.getElementById('risk-impact').value = '';
      document.getElementById('risk-lik-justification').value = '';
      document.getElementById('risk-imp-justification').value = '';

      // Reset State
      impactScores = { trust: 0, ops: 0, legal: 0, val: 0 };
      // Note: impactWeights are now global settings, not per-risk

      // Reset UI - Render tables
      renderLikelihoodTable();
      renderImpactTable();
      updateImpactCalculation();

      document.getElementById('badge-likelihood').textContent = 'Not Selected';
      document.getElementById('badge-likelihood').classList.remove('filled');
      document.getElementById('badge-likelihood').style.backgroundColor = '';
      document.getElementById('badge-impact').textContent = 'Not Calculated';
      document.getElementById('badge-impact').classList.remove('filled');
      document.getElementById('badge-impact').style.backgroundColor = '';

      // Clear errors
      ['fg-title', 'fg-desc'].forEach(id => document.getElementById(id).classList.remove('has-error'));
      document.getElementById('err-likelihood').style.display = 'none';
      document.getElementById('err-impact').style.display = 'none';

      // Set add mode
      editingRiskId = null;
      document.querySelector('.modal-header h2').textContent = 'Add New Risk';
      document.getElementById('modal-save').textContent = 'Save Risk';

      document.getElementById('modal-backdrop').classList.add('active');
      document.getElementById('risk-title').focus();
    }

    function openEditModal(risk) {
      // Pre-fill form with existing risk data
      document.getElementById('risk-title').value = risk.title;
      document.getElementById('risk-desc').value = risk.description;
      document.getElementById('risk-likelihood').value = risk.likelihood;
      document.getElementById('risk-impact').value = risk.impact;
      document.getElementById('risk-lik-justification').value = risk.likelihoodJustification || '';
      document.getElementById('risk-imp-justification').value = risk.impactJustification || '';

      // Restore impact details if available
      if (risk.impactDetails) {
        impactScores = { ...risk.impactDetails };
      } else {
        impactScores = { trust: 0, ops: 0, legal: 0, val: 0 };
      }

      // Note: impactWeights are global settings, not per-risk

      // Render tables and update UI to show selections
      renderLikelihoodTable();
      renderImpactTable();
      updateImpactCalculation();

      // Select the correct likelihood row
      const likRow = document.querySelector(`#likelihood-tbody tr[data-score="${risk.likelihood}"]`);
      if (likRow) {
        likRow.classList.add('selected');
        const badge = document.getElementById('badge-likelihood');
        badge.textContent = `${LIKELIHOOD_LABELS[risk.likelihood - 1]} (${risk.likelihood})`;
        badge.classList.add('filled');
        badge.style.backgroundColor = LEVEL_COLORS[risk.likelihood - 1];
      }

      // Clear errors
      ['fg-title', 'fg-desc'].forEach(id => document.getElementById(id).classList.remove('has-error'));
      document.getElementById('err-likelihood').style.display = 'none';
      document.getElementById('err-impact').style.display = 'none';

      // Set edit mode
      editingRiskId = risk.id;
      document.querySelector('.modal-header h2').textContent = 'Edit Risk';
      document.getElementById('modal-save').textContent = 'Update Risk';

      // Close detail panel and open modal
      closeDetail();
      document.getElementById('modal-backdrop').classList.add('active');
      document.getElementById('risk-title').focus();
    }

    function closeAddModal() {
      document.getElementById('modal-backdrop').classList.remove('active');
      editingRiskId = null;
    }

    function handleSaveRisk() {
      const titleInput = document.getElementById('risk-title');
      const descInput = document.getElementById('risk-desc');
      const likInput = document.getElementById('risk-likelihood');
      const impInput = document.getElementById('risk-impact');

      const title = titleInput.value.trim();
      const desc = descInput.value.trim();
      const likelihood = parseInt(likInput.value, 10);
      const impact = parseInt(impInput.value, 10);
      const likJustification = document.getElementById('risk-lik-justification').value.trim();
      const impJustification = document.getElementById('risk-imp-justification').value.trim();

      let valid = true;

      if (!title) { document.getElementById('fg-title').classList.add('has-error'); valid = false; }
      else { document.getElementById('fg-title').classList.remove('has-error'); }

      if (!desc) { document.getElementById('fg-desc').classList.add('has-error'); valid = false; }
      else { document.getElementById('fg-desc').classList.remove('has-error'); }

      if (!likelihood) {
        document.getElementById('err-likelihood').style.display = 'block';
        valid = false;
      } else {
        document.getElementById('err-likelihood').style.display = 'none';
      }

      if (!impact) {
        document.getElementById('err-impact').style.display = 'block';
        valid = false;
      } else {
        document.getElementById('err-impact').style.display = 'none';
      }

      if (!valid) return;

      if (editingRiskId) {
        // Edit mode - update existing risk
        const riskIndex = risks.findIndex(r => r.id === editingRiskId);
        if (riskIndex !== -1) {
          risks[riskIndex] = {
            ...risks[riskIndex],
            title: title,
            description: desc,
            likelihood: likelihood,
            impact: impact,
            impactDetails: { ...impactScores },
            impactWeights: { ...impactWeights },
            likelihoodJustification: likJustification,
            impactJustification: impJustification,
            updatedAt: new Date().toISOString()
          };
        }
      } else {
        // Add mode - create new risk
        const newRisk = {
          id: generateId(),
          title: title,
          description: desc,
          likelihood: likelihood,
          impact: impact,
          impactDetails: { ...impactScores },
          impactWeights: { ...impactWeights },
          likelihoodJustification: likJustification,
          impactJustification: impJustification,
          createdAt: new Date().toISOString()
        };
        risks.push(newRisk);
      }

      saveRisks();
      closeAddModal();
      renderGrid();
      renderStats();

      // Refresh detail panel if open for the same cell
      if (currentDetailCell &&
        currentDetailCell.likelihood === likelihood &&
        currentDetailCell.impact === impact) {
        openDetail(likelihood, impact);
      }
    }

    // ===== DELETE RISK =====
    function handleDeleteRisk(riskId) {
      if (!confirm('Are you sure you want to delete this risk?')) return;

      risks = risks.filter(r => r.id !== riskId);
      saveRisks();
      renderGrid();
      renderStats();

      // Refresh detail panel if open
      if (currentDetailCell) {
        openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
      }
    }

    // ===== APPETITE CONTROL =====
    function populateAppetiteSelect() {
      const sel = document.getElementById('appetite-select');
      for (let s = 1; s <= 25; s++) {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      }
      sel.value = appetiteThreshold;
    }

    // ===== RUBRIC TABLE RENDERING =====
    const RATING_CLASSES = ['rating-minimal', 'rating-low', 'rating-moderate', 'rating-high', 'rating-critical'];
    const LEVEL_LABELS = ['Minimal', 'Low', 'Moderate', 'High', 'Critical'];
    const LEVEL_COLORS = ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444'];

    function renderLikelihoodTable() {
      const tbody = document.getElementById('likelihood-tbody');
      tbody.innerHTML = '';

      likelihoodRubric.forEach(item => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-score', item.score);
        tr.onclick = () => selectLikelihoodRow(item, tr);

        tr.innerHTML = `
          <td class="rating-cell ${RATING_CLASSES[item.score - 1]}">
            <span class="rating-label">${item.rating}</span>
            <span class="rating-score">${item.score}</span>
          </td>
          <td class="prob-cell">${item.prob}</td>
          <td class="criteria-cell">${item.criteria}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function selectLikelihoodRow(item, rowElement) {
      document.getElementById('risk-likelihood').value = item.score;

      // Update selection UI - reset all rows first
      document.querySelectorAll('#likelihood-tbody tr').forEach(r => {
        r.classList.remove('selected');
        r.style.backgroundColor = '';
        // Reset text colors on non-rating cells
        r.querySelectorAll('td:not(.rating-cell)').forEach(td => {
          td.style.color = '';
        });
      });

      // Highlight selected row with rating color
      rowElement.classList.add('selected');
      rowElement.style.backgroundColor = LEVEL_COLORS[item.score - 1];
      // Make text more readable on colored background
      rowElement.querySelectorAll('td:not(.rating-cell)').forEach(td => {
        td.style.color = item.score >= 3 ? '#000' : '#fff';
      });

      const badge = document.getElementById('badge-likelihood');
      badge.textContent = `${item.rating} (${item.score})`;
      badge.classList.add('filled');
      badge.style.backgroundColor = LEVEL_COLORS[item.score - 1];

      document.getElementById('err-likelihood').style.display = 'none';

      // Update total risk score
      const impactVal = parseInt(document.getElementById('risk-impact').value, 10) || 0;
      updateTotalRiskScore(item.score, impactVal);
    }

    function renderImpactTable() {
      const tbody = document.getElementById('impact-tbody');
      tbody.innerHTML = '';

      impactRubric.forEach(item => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-score', item.score);

        // Rating cell (not clickable, just label)
        const ratingTd = document.createElement('td');
        ratingTd.className = `rating-cell ${RATING_CLASSES[item.score - 1]}`;
        ratingTd.innerHTML = `
          <span class="rating-label">${item.rating}</span>
          <span class="rating-score">${item.score}</span>
        `;
        tr.appendChild(ratingTd);

        // Category cells - each one is clickable
        ['trust', 'ops', 'legal', 'val'].forEach(cat => {
          const td = document.createElement('td');
          td.className = impactScores[cat] === item.score ? 'selected-cell' : '';
          td.style.cursor = 'pointer';
          td.textContent = item[cat];

          if (impactScores[cat] === item.score) {
            td.style.backgroundColor = LEVEL_COLORS[item.score - 1];
            td.style.color = item.score >= 3 ? '#000' : '#fff';
            td.style.fontWeight = '600';
          }

          td.onclick = (e) => {
            e.stopPropagation();
            selectImpactCell(cat, item.score);
          };

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function selectImpactCell(cat, score) {
      impactScores[cat] = score;
      renderImpactTable();
      updateImpactCalculation();
    }

    function updateWeights() {
      const t = parseFloat(document.getElementById('w-trust').value) || 0;
      const o = parseFloat(document.getElementById('w-ops').value) || 0;
      const l = parseFloat(document.getElementById('w-legal').value) || 0;
      const v = parseFloat(document.getElementById('w-val').value) || 0;

      impactWeights = { trust: t, ops: o, legal: l, val: v };
      updateImpactCalculation();
    }

    function updateImpactCalculation() {
      const { trust, ops, legal, val } = impactScores;
      const w = impactWeights;

      const totalWeight = w.trust + w.ops + w.legal + w.val;
      if (totalWeight === 0) return;

      const weightedSum = (trust * w.trust) + (ops * w.ops) + (legal * w.legal) + (val * w.val);
      const rawScore = weightedSum / totalWeight;
      const roundedScore = Math.round(rawScore);

      // Get likelihood value
      const likelihoodVal = parseInt(document.getElementById('risk-likelihood').value, 10) || 0;

      // Update UI
      if (trust && ops && legal && val) {
        document.getElementById('calc-formula').textContent =
          `(${trust}${w.trust} + ${ops}${w.ops} + ${legal}${w.legal} + ${val}${w.val})  ${totalWeight} = ${rawScore.toFixed(2)}`;
        document.getElementById('raw-score').textContent = ` ${roundedScore}`;

        const finalScoreEl = document.getElementById('final-score');
        finalScoreEl.textContent = `${roundedScore} ${LEVEL_LABELS[roundedScore - 1]}`;
        finalScoreEl.style.backgroundColor = LEVEL_COLORS[roundedScore - 1];

        document.getElementById('risk-impact').value = roundedScore;

        const badge = document.getElementById('badge-impact');
        badge.textContent = `${LEVEL_LABELS[roundedScore - 1]} (${roundedScore})`;
        badge.classList.add('filled');
        badge.style.backgroundColor = LEVEL_COLORS[roundedScore - 1];
        badge.style.color = '#fff';

        document.getElementById('err-impact').style.display = 'none';

        // Update total risk score
        updateTotalRiskScore(likelihoodVal, roundedScore);
      } else {
        document.getElementById('calc-formula').textContent = 'Select all categories';
        document.getElementById('raw-score').textContent = '';
        document.getElementById('final-score').textContent = '?';
        document.getElementById('final-score').style.backgroundColor = '#64748b';
        document.getElementById('risk-impact').value = '';

        // Reset total risk score
        updateTotalRiskScore(likelihoodVal, 0);
      }
    }

    function updateTotalRiskScore(likelihood, impact) {
      const riskFormulaEl = document.getElementById('risk-formula');
      const totalRiskEl = document.getElementById('total-risk-score');

      if (likelihood && impact) {
        const totalScore = likelihood * impact;
        const color = getColorForScore(totalScore);

        riskFormulaEl.textContent = `${likelihood}  ${impact} = ${totalScore}`;
        totalRiskEl.textContent = `${totalScore} ${color.level}`;
        totalRiskEl.style.backgroundColor = color.bg;
        totalRiskEl.style.color = color.text;
      } else if (likelihood) {
        riskFormulaEl.textContent = `${likelihood}  ?`;
        totalRiskEl.textContent = '?';
        totalRiskEl.style.backgroundColor = '#64748b';
        totalRiskEl.style.color = '#fff';
      } else if (impact) {
        riskFormulaEl.textContent = `?  ${impact}`;
        totalRiskEl.textContent = '?';
        totalRiskEl.style.backgroundColor = '#64748b';
        totalRiskEl.style.color = '#fff';
      } else {
        riskFormulaEl.textContent = 'Likelihood  Impact';
        totalRiskEl.textContent = '?';
        totalRiskEl.style.backgroundColor = '#64748b';
        totalRiskEl.style.color = '#fff';
      }
    }

    // ===== RACI VIEW FUNCTIONS =====
    function switchView(view) {
      currentView = view;

      const mainEl = document.querySelector('main');
      const raciEl = document.getElementById('raci-view');
      const companyEl = document.getElementById('company-view');
      const buttons = {
        heatmap: document.getElementById('view-heatmap'),
        raci: document.getElementById('view-raci'),
        company: document.getElementById('view-company')
      };

      // Hide all views
      mainEl.style.display = 'none';
      raciEl.style.display = 'none';
      companyEl.style.display = 'none';

      // Remove active from all buttons
      Object.values(buttons).forEach(btn => btn.classList.remove('active'));

      // Show selected view and activate button
      if (view === 'raci') {
        raciEl.style.display = 'block';
        renderRaciTable();
      } else if (view === 'company') {
        companyEl.style.display = 'block';
      } else {
        mainEl.style.display = 'block';
      }

      buttons[view].classList.add('active');
    }

    function renderRaciTable() {
      const thead = document.getElementById('raci-thead');
      const tbody = document.getElementById('raci-tbody');

      // Render header row
      thead.innerHTML = '';
      const headerRow = document.createElement('tr');

      // Corner cell (Task/Role header)
      const cornerTh = document.createElement('th');
      cornerTh.className = 'task-header';
      cornerTh.textContent = 'Risk / Role';
      headerRow.appendChild(cornerTh);

      // Role headers
      raciMatrix.roles.forEach(role => {
        const th = document.createElement('th');
        th.className = 'role-header';
        th.innerHTML = `${escapeHtml(role.name)}<button class="delete-col-btn" data-role-id="${role.id}" title="Delete role">&times;</button>`;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);

      // Render body rows
      tbody.innerHTML = '';
      raciMatrix.tasks.forEach(task => {
        const tr = document.createElement('tr');

        // Task name cell
        const taskTd = document.createElement('td');
        taskTd.className = 'task-cell';
        taskTd.innerHTML = `${escapeHtml(task.name)}<button class="delete-row-btn" data-task-id="${task.id}" title="Delete task">&times;</button>`;
        tr.appendChild(taskTd);

        // RACI cells for each role
        raciMatrix.roles.forEach(role => {
          const td = document.createElement('td');
          td.className = 'raci-cell';

          const key = `${task.id}_${role.id}`;
          const currentValue = raciMatrix.assignments[key] || '';

          const select = document.createElement('select');
          select.className = 'raci-select';
          if (currentValue) {
            select.classList.add(`raci-${currentValue.toLowerCase()}`);
          }
          select.setAttribute('data-task-id', task.id);
          select.setAttribute('data-role-id', role.id);

          RACI_VALUES.forEach(val => {
            const option = document.createElement('option');
            option.value = val;
            option.textContent = val || '-';
            if (val === currentValue) option.selected = true;
            select.appendChild(option);
          });

          select.addEventListener('change', handleRaciChange);

          td.appendChild(select);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function handleRaciChange(e) {
      const select = e.target;
      const taskId = select.getAttribute('data-task-id');
      const roleId = select.getAttribute('data-role-id');
      const value = select.value;

      const key = `${taskId}_${roleId}`;

      if (value) {
        raciMatrix.assignments[key] = value;
      } else {
        delete raciMatrix.assignments[key];
      }

      // Update select styling
      select.className = 'raci-select';
      if (value) {
        select.classList.add(`raci-${value.toLowerCase()}`);
      }

      saveRaciData();
    }

    // ===== RACI TASK CRUD =====
    function openAddTaskModal() {
      document.getElementById('task-name').value = '';
      document.getElementById('fg-task-name').classList.remove('has-error');
      editingTaskId = null;
      document.querySelector('#task-modal .modal-header h2').textContent = 'Add Task';
      document.getElementById('task-modal-save').textContent = 'Add Task';
      document.getElementById('task-modal-backdrop').classList.add('active');
      document.getElementById('task-name').focus();
    }

    function closeAddTaskModal() {
      document.getElementById('task-modal-backdrop').classList.remove('active');
      editingTaskId = null;
    }

    function handleSaveTask() {
      const name = document.getElementById('task-name').value.trim();

      if (!name) {
        document.getElementById('fg-task-name').classList.add('has-error');
        return;
      }

      document.getElementById('fg-task-name').classList.remove('has-error');

      if (editingTaskId) {
        const task = raciMatrix.tasks.find(t => t.id === editingTaskId);
        if (task) task.name = name;
      } else {
        const newTask = {
          id: 'task_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8),
          name: name
        };
        raciMatrix.tasks.push(newTask);
      }

      saveRaciData();
      closeAddTaskModal();
      renderRaciTable();
    }

    function handleDeleteTask(taskId) {
      if (!confirm('Delete this task? All RACI assignments for this task will be removed.')) return;

      raciMatrix.tasks = raciMatrix.tasks.filter(t => t.id !== taskId);

      // Remove related assignments
      Object.keys(raciMatrix.assignments).forEach(key => {
        if (key.startsWith(taskId + '_')) {
          delete raciMatrix.assignments[key];
        }
      });

      saveRaciData();
      renderRaciTable();
    }

    // ===== RACI ROLE CRUD =====
    function openAddRoleModal() {
      document.getElementById('role-name').value = '';
      document.getElementById('fg-role-name').classList.remove('has-error');
      editingRoleId = null;
      document.querySelector('#role-modal .modal-header h2').textContent = 'Add Role';
      document.getElementById('role-modal-save').textContent = 'Add Role';
      document.getElementById('role-modal-backdrop').classList.add('active');
      document.getElementById('role-name').focus();
    }

    function closeAddRoleModal() {
      document.getElementById('role-modal-backdrop').classList.remove('active');
      editingRoleId = null;
    }

    function handleSaveRole() {
      const name = document.getElementById('role-name').value.trim();

      if (!name) {
        document.getElementById('fg-role-name').classList.add('has-error');
        return;
      }

      document.getElementById('fg-role-name').classList.remove('has-error');

      if (editingRoleId) {
        const role = raciMatrix.roles.find(r => r.id === editingRoleId);
        if (role) role.name = name;
      } else {
        const newRole = {
          id: 'role_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8),
          name: name
        };
        raciMatrix.roles.push(newRole);
      }

      saveRaciData();
      closeAddRoleModal();
      renderRaciTable();
    }

    function handleDeleteRole(roleId) {
      if (!confirm('Delete this role? All RACI assignments for this role will be removed.')) return;

      raciMatrix.roles = raciMatrix.roles.filter(r => r.id !== roleId);

      // Remove related assignments
      Object.keys(raciMatrix.assignments).forEach(key => {
        if (key.endsWith('_' + roleId)) {
          delete raciMatrix.assignments[key];
        }
      });

      saveRaciData();
      renderRaciTable();
    }

    // ===== IMPORT RISKS AS TASKS =====
    function importRisksAsTasks() {
      if (risks.length === 0) {
        alert('No risks to import. Add risks from the Heatmap view first.');
        return;
      }

      const existingNames = new Set(raciMatrix.tasks.map(t => t.name.toLowerCase()));
      let imported = 0;

      risks.forEach(risk => {
        if (!existingNames.has(risk.title.toLowerCase())) {
          raciMatrix.tasks.push({
            id: 'task_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8),
            name: risk.title
          });
          existingNames.add(risk.title.toLowerCase());
          imported++;
        }
      });

      if (imported > 0) {
        saveRaciData();
        renderRaciTable();
        alert(`Imported ${imported} risk(s) as tasks.`);
      } else {
        alert('All risks are already in the RACI matrix.');
      }
    }

    // ===== EVENT LISTENERS =====
    function init() {
      // 1. Initial load from local storage (fast startup)
      risks = loadRisks();
      appetiteThreshold = loadAppetite();
      impactWeights = loadWeights();
      loadRubricData();
      raciMatrix = loadRaciData();

      // 2. Initialize Firebase
      const fbStarted = initFirebase();
      if (fbStarted) {
        setupRealtimeListeners();
      }

      // 3. Initial render
      renderGrid();
      renderStats();

      // Grid cell clicks (event delegation)
      document.getElementById('heatmap-grid').addEventListener('click', function (e) {
        const cell = e.target.closest('.heatmap-cell');
        if (!cell) return;
        const lik = parseInt(cell.getAttribute('data-likelihood'), 10);
        const imp = parseInt(cell.getAttribute('data-impact'), 10);
        openDetail(lik, imp);
      });

      // Grid cell keyboard (Enter/Space)
      document.getElementById('heatmap-grid').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          const cell = e.target.closest('.heatmap-cell');
          if (!cell) return;
          e.preventDefault();
          const lik = parseInt(cell.getAttribute('data-likelihood'), 10);
          const imp = parseInt(cell.getAttribute('data-impact'), 10);
          openDetail(lik, imp);
        }
      });

      // Detail panel close
      document.getElementById('detail-close').addEventListener('click', closeDetail);
      document.getElementById('detail-backdrop').addEventListener('click', closeDetail);

      // Detail panel delete delegation
      document.getElementById('detail-body').addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-danger[data-risk-id]');
        if (!btn) return;
        handleDeleteRisk(btn.getAttribute('data-risk-id'));
      });

      // Add risk button
      document.getElementById('add-risk-btn').addEventListener('click', openAddModal);

      // Modal close
      document.getElementById('modal-close').addEventListener('click', closeAddModal);
      document.getElementById('modal-cancel').addEventListener('click', closeAddModal);
      document.getElementById('modal-backdrop').addEventListener('click', function (e) {
        if (e.target === this) closeAddModal();
      });

      // Modal save
      document.getElementById('modal-save').addEventListener('click', handleSaveRisk);

      // Enter key in modal form
      document.getElementById('risk-title').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); handleSaveRisk(); }
      });

      // Escape key
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          if (document.getElementById('modal-backdrop').classList.contains('active')) {
            closeAddModal();
          } else if (document.getElementById('settings-backdrop').classList.contains('active')) {
            closeSettingsModal();
          } else if (document.getElementById('task-modal-backdrop').classList.contains('active')) {
            closeAddTaskModal();
          } else if (document.getElementById('role-modal-backdrop').classList.contains('active')) {
            closeAddRoleModal();
          } else if (document.getElementById('detail-panel').classList.contains('active')) {
            closeDetail();
          }
        }
      });

      // Settings button
      document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
      document.getElementById('settings-close').addEventListener('click', closeSettingsModal);
      document.getElementById('settings-cancel').addEventListener('click', closeSettingsModal);
      document.getElementById('settings-save').addEventListener('click', saveSettings);
      document.getElementById('settings-backdrop').addEventListener('click', function (e) {
        if (e.target === this) closeSettingsModal();
      });

      // Settings weight inputs - update total display
      ['settings-w-trust', 'settings-w-ops', 'settings-w-legal', 'settings-w-val'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateWeightTotalDisplay);
      });

      // Rubric editor reset buttons
      document.getElementById('reset-likelihood-rubric').addEventListener('click', resetLikelihoodRubricEditor);
      document.getElementById('reset-impact-rubric').addEventListener('click', resetImpactRubricEditor);

      // Cross-tab sync
      window.addEventListener('storage', function (e) {
        if (e.key === STORAGE_KEY) {
          risks = loadRisks();
          renderGrid();
          renderStats();
          if (currentDetailCell) {
            openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
          }
        }
        if (e.key === APPETITE_KEY) {
          appetiteThreshold = loadAppetite();
          renderGrid();
          renderStats();
          if (currentDetailCell) {
            openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
          }
        }
        if (e.key === WEIGHTS_KEY) {
          impactWeights = loadWeights();
          recalculateRiskImpacts();
          renderGrid();
          renderStats();
          if (currentDetailCell) {
            openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
          }
        }
        if (e.key === RUBRIC_KEY) {
          loadRubricData();
          renderGrid();
          renderStats();
          if (currentDetailCell) {
            openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
          }
        }
        if (e.key === RACI_KEY) {
          raciMatrix = loadRaciData();
          if (currentView === 'raci') {
            renderRaciTable();
          }
        }
      });

      // View toggle
      document.getElementById('view-heatmap').addEventListener('click', () => switchView('heatmap'));
      document.getElementById('view-raci').addEventListener('click', () => switchView('raci'));
      document.getElementById('view-company').addEventListener('click', () => switchView('company'));

      // RACI table event delegation for delete buttons
      document.getElementById('raci-table').addEventListener('click', function (e) {
        const deleteColBtn = e.target.closest('.delete-col-btn');
        if (deleteColBtn) {
          handleDeleteRole(deleteColBtn.getAttribute('data-role-id'));
          return;
        }

        const deleteRowBtn = e.target.closest('.delete-row-btn');
        if (deleteRowBtn) {
          handleDeleteTask(deleteRowBtn.getAttribute('data-task-id'));
          return;
        }
      });

      // Add task modal
      document.getElementById('add-task-btn').addEventListener('click', openAddTaskModal);
      document.getElementById('task-modal-close').addEventListener('click', closeAddTaskModal);
      document.getElementById('task-modal-cancel').addEventListener('click', closeAddTaskModal);
      document.getElementById('task-modal-save').addEventListener('click', handleSaveTask);
      document.getElementById('task-modal-backdrop').addEventListener('click', function (e) {
        if (e.target === this) closeAddTaskModal();
      });
      document.getElementById('task-name').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); handleSaveTask(); }
      });

      // Add role modal
      document.getElementById('add-role-btn').addEventListener('click', openAddRoleModal);
      document.getElementById('role-modal-close').addEventListener('click', closeAddRoleModal);
      document.getElementById('role-modal-cancel').addEventListener('click', closeAddRoleModal);
      document.getElementById('role-modal-save').addEventListener('click', handleSaveRole);
      document.getElementById('role-modal-backdrop').addEventListener('click', function (e) {
        if (e.target === this) closeAddRoleModal();
      });
      document.getElementById('role-name').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); handleSaveRole(); }
      });

      // Import risks button
      document.getElementById('import-risks-btn').addEventListener('click', importRisksAsTasks);
    }

    // ===== SETTINGS MODAL =====
    function populateSettingsAppetite() {
      const select = document.getElementById('settings-appetite');
      select.innerHTML = '';
      for (let i = 1; i <= 25; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.text = `${i} - Scores > ${i} are outside appetite`;
        if (i === appetiteThreshold) opt.selected = true;
        select.appendChild(opt);
      }
    }

    function openSettingsModal() {
      populateSettingsAppetite();

      // Load current weights into inputs
      document.getElementById('settings-w-trust').value = impactWeights.trust;
      document.getElementById('settings-w-ops').value = impactWeights.ops;
      document.getElementById('settings-w-legal').value = impactWeights.legal;
      document.getElementById('settings-w-val').value = impactWeights.val;

      updateWeightTotalDisplay();

      // Render rubric editors with current data
      renderLikelihoodEditor();
      renderImpactEditor();

      document.getElementById('settings-backdrop').classList.add('active');
    }

    function closeSettingsModal() {
      document.getElementById('settings-backdrop').classList.remove('active');
    }

    function updateWeightTotalDisplay() {
      const t = parseFloat(document.getElementById('settings-w-trust').value) || 0;
      const o = parseFloat(document.getElementById('settings-w-ops').value) || 0;
      const l = parseFloat(document.getElementById('settings-w-legal').value) || 0;
      const v = parseFloat(document.getElementById('settings-w-val').value) || 0;
      const total = t + o + l + v;

      const display = document.getElementById('weight-total-display');
      display.innerHTML = `Total: <strong>${total}%</strong>`;

      if (total !== 100) {
        display.classList.add('invalid');
      } else {
        display.classList.remove('invalid');
      }
    }

    function recalculateRiskImpacts() {
      // Recalculate the impact score for all existing risks using the current global weights
      const w = impactWeights;
      const totalWeight = w.trust + w.ops + w.legal + w.val;
      if (totalWeight === 0) return;

      let changed = false;
      risks.forEach(risk => {
        if (risk.impactDetails) {
          const d = risk.impactDetails;
          // Only recalculate if all 4 category scores are present
          if (d.trust && d.ops && d.legal && d.val) {
            const weightedSum = (d.trust * w.trust) + (d.ops * w.ops) + (d.legal * w.legal) + (d.val * w.val);
            const newImpact = Math.round(weightedSum / totalWeight);
            if (newImpact !== risk.impact) {
              risk.impact = newImpact;
              changed = true;
            }
            // Update the stored weights snapshot to reflect the new weights
            risk.impactWeights = { ...w };
          }
        }
      });

      if (changed) {
        saveRisks();
      }
    }

    function saveSettings() {
      // Get values
      const newAppetite = parseInt(document.getElementById('settings-appetite').value, 10);
      const newWeights = {
        trust: parseFloat(document.getElementById('settings-w-trust').value) || 0,
        ops: parseFloat(document.getElementById('settings-w-ops').value) || 0,
        legal: parseFloat(document.getElementById('settings-w-legal').value) || 0,
        val: parseFloat(document.getElementById('settings-w-val').value) || 0
      };

      // Validate weights sum to 100 (optional - just warn)
      const total = newWeights.trust + newWeights.ops + newWeights.legal + newWeights.val;
      if (total !== 100) {
        if (!confirm(`Weights total ${total}% instead of 100%. Continue anyway?`)) {
          return;
        }
      }

      // Save appetite
      appetiteThreshold = newAppetite;
      saveAppetite();

      // Save weights
      impactWeights = newWeights;
      saveWeights();

      // Recalculate all existing risk impact scores with new weights
      recalculateRiskImpacts();

      // Collect and save rubric edits
      const rubricEdits = collectRubricEdits();
      likelihoodRubric = rubricEdits.likelihood;
      impactRubric = rubricEdits.impact;
      saveRubricData();

      // Update UI
      closeSettingsModal();
      renderGrid();
      renderStats();

      if (currentDetailCell) {
        openDetail(currentDetailCell.likelihood, currentDetailCell.impact);
      }
    }

    // ===== RUBRIC EDITOR FUNCTIONS =====
    function renderLikelihoodEditor() {
      const container = document.getElementById('likelihood-editor');
      container.innerHTML = '';

      likelihoodRubric.forEach(item => {
        const div = document.createElement('div');
        div.className = 'rubric-editor-item';
        div.setAttribute('data-score', item.score);

        const badgeColor = LEVEL_COLORS[item.score - 1];

        div.innerHTML = `
          <span class="editor-rating" style="background:${badgeColor};">${item.rating} (${item.score})</span>
          <div class="editor-fields likelihood-fields">
            <div class="editor-field">
              <span class="editor-field-label">Probability</span>
              <input type="text" class="lik-prob" value="${escapeAttr(item.prob)}">
            </div>
            <div class="editor-field">
              <span class="editor-field-label">Criteria</span>
              <textarea class="lik-criteria">${escapeHtml(item.criteria)}</textarea>
            </div>
          </div>
        `;

        container.appendChild(div);
      });
    }

    function renderImpactEditor() {
      const container = document.getElementById('impact-editor');
      container.innerHTML = '';

      const catLabels = {
        trust: 'Trust / Reputational',
        ops: 'Operational Scope',
        legal: 'Legal / Compliance / Environmental',
        val: 'Enterprise Value'
      };

      impactRubric.forEach(item => {
        const div = document.createElement('div');
        div.className = 'rubric-editor-item';
        div.setAttribute('data-score', item.score);

        const badgeColor = LEVEL_COLORS[item.score - 1];

        let fieldsHtml = '';
        ['trust', 'ops', 'legal', 'val'].forEach(cat => {
          fieldsHtml += `
            <div class="editor-field">
              <span class="editor-field-label">${catLabels[cat]}</span>
              <textarea class="imp-${cat}">${escapeHtml(item[cat])}</textarea>
            </div>
          `;
        });

        div.innerHTML = `
          <span class="editor-rating" style="background:${badgeColor};">${item.rating} (${item.score})</span>
          <div class="editor-fields impact-fields">
            ${fieldsHtml}
          </div>
        `;

        container.appendChild(div);
      });
    }

    function collectRubricEdits() {
      const likItems = document.querySelectorAll('#likelihood-editor .rubric-editor-item');
      const newLikelihood = [];
      likItems.forEach(item => {
        const score = parseInt(item.getAttribute('data-score'), 10);
        const base = likelihoodRubric.find(r => r.score === score) || DEFAULT_LIKELIHOOD_RUBRIC.find(r => r.score === score);
        newLikelihood.push({
          score: score,
          rating: base.rating,
          prob: item.querySelector('.lik-prob').value.trim() || base.prob,
          criteria: item.querySelector('.lik-criteria').value.trim() || base.criteria
        });
      });

      const impItems = document.querySelectorAll('#impact-editor .rubric-editor-item');
      const newImpact = [];
      impItems.forEach(item => {
        const score = parseInt(item.getAttribute('data-score'), 10);
        const base = impactRubric.find(r => r.score === score) || DEFAULT_IMPACT_RUBRIC.find(r => r.score === score);
        newImpact.push({
          score: score,
          rating: base.rating,
          trust: item.querySelector('.imp-trust').value.trim() || base.trust,
          ops: item.querySelector('.imp-ops').value.trim() || base.ops,
          legal: item.querySelector('.imp-legal').value.trim() || base.legal,
          val: item.querySelector('.imp-val').value.trim() || base.val
        });
      });

      return { likelihood: newLikelihood, impact: newImpact };
    }

    function escapeAttr(str) {
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function resetLikelihoodRubricEditor() {
      // Render editor with defaults without mutating state
      // State is only updated when the user clicks Save
      const container = document.getElementById('likelihood-editor');
      container.innerHTML = '';
      DEFAULT_LIKELIHOOD_RUBRIC.forEach(item => {
        const div = document.createElement('div');
        div.className = 'rubric-editor-item';
        div.setAttribute('data-score', item.score);
        const badgeColor = LEVEL_COLORS[item.score - 1];
        div.innerHTML = `
          <span class="editor-rating" style="background:${badgeColor};">${item.rating} (${item.score})</span>
          <div class="editor-fields likelihood-fields">
            <div class="editor-field">
              <span class="editor-field-label">Probability</span>
              <input type="text" class="lik-prob" value="${escapeAttr(item.prob)}">
            </div>
            <div class="editor-field">
              <span class="editor-field-label">Criteria</span>
              <textarea class="lik-criteria">${escapeHtml(item.criteria)}</textarea>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function resetImpactRubricEditor() {
      // Render editor with defaults without mutating state
      // State is only updated when the user clicks Save
      const container = document.getElementById('impact-editor');
      container.innerHTML = '';
      const catLabels = {
        trust: 'Trust / Reputational',
        ops: 'Operational Scope',
        legal: 'Legal / Compliance / Environmental',
        val: 'Enterprise Value'
      };
      DEFAULT_IMPACT_RUBRIC.forEach(item => {
        const div = document.createElement('div');
        div.className = 'rubric-editor-item';
        div.setAttribute('data-score', item.score);
        const badgeColor = LEVEL_COLORS[item.score - 1];
        let fieldsHtml = '';
        ['trust', 'ops', 'legal', 'val'].forEach(cat => {
          fieldsHtml += `
            <div class="editor-field">
              <span class="editor-field-label">${catLabels[cat]}</span>
              <textarea class="imp-${cat}">${escapeHtml(item[cat])}</textarea>
            </div>
          `;
        });
        div.innerHTML = `
          <span class="editor-rating" style="background:${badgeColor};">${item.rating} (${item.score})</span>
          <div class="editor-fields impact-fields">
            ${fieldsHtml}
          </div>
        `;
        container.appendChild(div);
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>